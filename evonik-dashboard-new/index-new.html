<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evonik Production Coordination Hub</title>
    <link rel="stylesheet" href="shared-styles-new.css">
    <style>
        /* Page-specific styles */
        .header {
            background: linear-gradient(135deg, var(--evonik-purple) 0%, var(--evonik-dark-purple) 100%);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: var(--success-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Floating Demo Controls */
        .demo-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .demo-fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--evonik-purple), var(--evonik-light-purple));
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 46, 139, 0.4);
            transition: all 0.3s ease;
        }

        .demo-fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(139, 46, 139, 0.6);
        }

        .demo-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 1rem;
            min-width: 280px;
            display: none;
        }

        .demo-menu.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .demo-menu-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .demo-menu-item {
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-gray);
            font-size: 0.9rem;
        }

        .demo-menu-item:hover {
            background: var(--evonik-purple);
            color: white;
            transform: translateX(4px);
        }

        .regional-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .region-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .region-card.operational {
            border-left-color: var(--success-green);
            background: rgba(22, 163, 74, 0.02);
        }

        .region-card.warning {
            border-left-color: var(--warning-orange);
            background: rgba(234, 88, 12, 0.02);
        }

        .region-name {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .region-metrics {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .region-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .inventory-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .inventory-location {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .inventory-level {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--evonik-purple);
            margin-bottom: 0.75rem;
        }

        .inventory-level.warning {
            color: var(--warning-orange);
        }

        .inventory-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .inventory-status.adequate {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success-green);
        }

        .inventory-status.low {
            background: rgba(234, 88, 12, 0.1);
            color: var(--warning-orange);
        }

        .event-timeline {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .timeline-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }

        .timeline-list {
            list-style: none;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-left: 2px solid var(--border-gray);
            padding-left: 1.5rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 1.25rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--evonik-purple);
        }

        .timeline-time {
            font-weight: 600;
            color: var(--text-light);
            min-width: 70px;
            font-size: 0.9rem;
        }

        .timeline-content {
            flex: 1;
            color: var(--text-dark);
        }

        .timeline-icon {
            margin-right: 0.5rem;
        }

        .events-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .events-list {
            list-style: none;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-gray);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .event-date {
            font-weight: 700;
            color: var(--evonik-purple);
            min-width: 70px;
            text-align: center;
            font-size: 0.95rem;
        }

        .event-content {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .event-detail {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .alert-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-gray);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .alert-header {
            background: linear-gradient(135deg, var(--warning-orange), #F97316);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .alert-count {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .alert-list {
            list-style: none;
            padding: 0;
        }

        .alert-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: start;
            gap: 1rem;
            transition: background 0.2s;
        }

        .alert-item:hover {
            background: var(--bg-gray);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .alert-detail {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .total-metric {
            text-align: center;
            padding-top: 1rem;
            border-top: 2px solid var(--border-gray);
            margin-top: 1rem;
        }

        .total-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .total-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--evonik-purple);
        }

        #plantWorldMap { 
            height: 480px; 
            border-radius: 12px; 
            border: 1px solid var(--border-gray); 
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .leaflet-interactive { 
            cursor: pointer; 
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">üß™ Evonik</div>
                <div>
                    <div style="font-size: 1.2rem; font-weight: 600;">Production Coordination Hub</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Jurong Island Methionine Complex - Singapore</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="userDisplay">Live System</span>
            </div>
        </div>
    </header>

    <nav class="stakeholder-nav">
        <div class="nav-content">
            <div class="stakeholder-btn active">
                üéØ Coordination Hub
            </div>
            <a href="optimizer-new.html" class="stakeholder-btn optimizer">
                ü§ñ AI Decision Optimizer
            </a>
            <a href="sales-new.html" class="stakeholder-btn">
                üìà Sales
            </a>
            <a href="global-supply-chain-new.html" class="stakeholder-btn">
                üåè Global SC
            </a>
            <a href="local-supply-chain-new.html" class="stakeholder-btn">
                üìä Local SC
            </a>
            <a href="production-new.html" class="stakeholder-btn">
                üè≠ Production
            </a>
        </div>
    </nav>

    <div class="alerts-banner" id="alertsBanner">
        <strong>üö® ALERT:</strong> <span id="alertMessage"></span>
    </div>

    <main class="main-content">
        <!-- Current Status Overview -->
        <div class="section-header">
            <h2 class="section-title">Mission Control - System Status</h2>
            <div style="color: var(--text-light); font-size: 0.9rem;">
                Cross-functional coordination overview ‚Ä¢ Last updated: <span id="lastUpdate">Just now</span>
            </div>
        </div>

        <!-- System Health Dashboard -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üö¶ System Health</div>
                    <div class="card-status status-operational" id="overallStatus">Operational</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Production</div>
                    <div class="metric-value" id="productionStatusText">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Inventory</div>
                    <div class="metric-value" id="inventoryStatusText">
                        <span class="status-indicator warning">
                            <span class="status-dot"></span>
                            <span>Action Needed</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Shipping</div>
                    <div class="metric-value">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span id="shippingStatusText">On Schedule</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Orders</div>
                    <div class="metric-value">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span id="ordersStatusText">Confirmed</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <div class="card-title">Plant Operations</div>
                    <div class="card-status status-operational" id="plantStatus">Operational</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="metric">
                        <div class="metric-label">ME5 Unit</div>
                        <div class="metric-value" id="me5Output">620 MT/day</div>
                        <div class="metric-subtext" id="me5Status">Online</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">ME6 Unit</div>
                        <div class="metric-value" id="me6Output">345 MT/day</div>
                        <div class="metric-subtext" id="me6Status">Online</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Output</div>
                        <div class="metric-value" id="totalOutput">965 MT/day</div>
                        <div class="metric-subtext">Target: 965 MT/day</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Alerts -->
        <div class="alert-card">
            <div class="alert-header">
                <h3>üîî Critical Alerts</h3>
                <span class="alert-count" id="alertCount">2 Active</span>
            </div>
            <ul class="alert-list" id="alertsList">
                <li class="alert-item">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-content">
                        <div class="alert-title">ME6 Unit - Maintenance Required</div>
                        <div class="alert-detail">Scheduled maintenance window in 48 hours ‚Ä¢ Coordinate with production team</div>
                    </div>
                </li>
                <li class="alert-item">
                    <span class="alert-icon">üì¶</span>
                    <div class="alert-content">
                        <div class="alert-title">Singapore Inventory Below Safety Stock</div>
                        <div class="alert-detail">Current status requires attention ‚Ä¢ Review with supply chain team</div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- Regional Fulfillment Status -->
        <h2 class="section-title">üåç Regional Fulfillment Status</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            High-level regional order status ‚Ä¢ For detailed customer information, see Sales Dashboard
        </p>
        
        <div class="regional-grid">
            <div class="region-card operational">
                <div class="region-name">APAC</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="apacOrders">8 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Adequate</span>
                    </div>
                </div>
            </div>

            <div class="region-card warning">
                <div class="region-name">Europe</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator warning">
                            <span class="status-dot"></span>
                            <span>Delayed</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="europeOrders">5 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Low</span>
                    </div>
                </div>
            </div>

            <div class="region-card operational">
                <div class="region-name">Americas</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="americasOrders">12 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Adequate</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finished Goods Inventory -->
        <h2 class="section-title">üì¶ Finished Goods Inventory</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            Regional inventory levels ‚Ä¢ For detailed inventory management, see Local Supply Chain Dashboard
        </p>

        <div class="inventory-grid">
            <div class="inventory-card">
                <div class="inventory-location">üáßüá™ Antwerp</div>
                <div class="inventory-level" id="antwerpInventory">2.8K MT</div>
                <div class="inventory-status adequate">
                    <span class="status-dot"></span>
                    <span>Adequate</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="inventory-location">üá∫üá∏ Mobile</div>
                <div class="inventory-level warning" id="mobileInventory">1.2K MT</div>
                <div class="inventory-status low">
                    <span class="status-dot"></span>
                    <span>Low Stock</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="inventory-location">üá∏üá¨ Singapore</div>
                <div class="inventory-level" id="singaporeInventory">3.4K MT</div>
                <div class="inventory-status adequate">
                    <span class="status-dot"></span>
                    <span>Adequate</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="total-metric">
                    <div class="total-label">Global Total</div>
                    <div class="total-value" id="globalInventory">7.4K MT</div>
                </div>
            </div>
        </div>

        <!-- Upcoming Events & Timeline -->
        <div class="dashboard-grid">
            <!-- Upcoming Events -->
            <div class="events-card">
                <div class="timeline-header">üìÖ Upcoming Events (Next 7 Days)</div>
                <ul class="events-list">
                    <li class="event-item">
                        <div class="event-date">Nov 2</div>
                        <div class="event-content">
                            <div class="event-title">ME5 Maintenance</div>
                            <div class="event-detail">24-hour cycle maintenance + 12hrs startup</div>
                        </div>
                    </li>
                    <li class="event-item">
                        <div class="event-date">Nov 5</div>
                        <div class="event-content">
                            <div class="event-title">Rotterdam Bulk Shipment</div>
                            <div class="event-detail">2,400 MT scheduled departure</div>
                        </div>
                    </li>
                    <li class="event-item">
                        <div class="event-date">Nov 7</div>
                        <div class="event-content">
                            <div class="event-title">Monthly Planning Meeting</div>
                            <div class="event-detail">Cross-functional coordination session</div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Coordination Timeline -->
            <div class="event-timeline" style="grid-column: span 2;">
                <div class="timeline-header">‚è±Ô∏è Coordination Timeline (Last 30 minutes)</div>
                <ul class="timeline-list" id="timelineList">
                    <li class="timeline-item">
                        <div class="timeline-time">14:15</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">‚öôÔ∏è</span>
                            <strong>Production:</strong> ME6 equipment issue detected
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:16</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üåè</span>
                            <strong>Global SC:</strong> Capacity rebalanced to Mobile plant
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:18</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üìä</span>
                            <strong>Sales:</strong> Customer deliveries adjusted
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:25</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üì¶</span>
                            <strong>Local SC:</strong> Emergency raw material ordered
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- World Plants Map -->
        <h2 class="section-title">üó∫Ô∏è Global Plant Locations</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            Countries with Evonik methionine plants are highlighted ‚Ä¢ Click for plant details
        </p>
        <div id="plantWorldMap"></div>
    </main>

    <!-- Floating Demo Controls -->
    <div class="demo-fab">
        <button class="demo-fab-button" id="demoFabBtn" onclick="toggleDemoMenu()">
            üéÆ
        </button>
        <div class="demo-menu" id="demoMenu">
            <div class="demo-menu-header">üéÆ Live Demo Controls</div>
            <div class="demo-menu-item" onclick="triggerEquipmentFailure()">
                ‚öôÔ∏è Equipment Failure
            </div>
            <div class="demo-menu-item" onclick="triggerBulkOrderSync()">
                üìä Bulk Order Sync
            </div>
            <div class="demo-menu-item" onclick="triggerSupplyChainAdjustment()">
                üîÑ SC Adjustment
            </div>
            <div class="demo-menu-item" onclick="triggerGlobalRebalancing()">
                üåè Global Rebalancing
            </div>
            <div class="demo-menu-item" onclick="resetDemo()" style="border-top: 1px solid var(--border-gray); margin-top: 0.5rem; padding-top: 0.75rem;">
                üîÑ Reset Demo
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Toggle demo menu
        function toggleDemoMenu() {
            const menu = document.getElementById('demoMenu');
            menu.classList.toggle('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const fab = document.querySelector('.demo-fab');
            const menu = document.getElementById('demoMenu');
            if (!fab.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 'Just now';
        }
        updateTime();
        setInterval(updateTime, 30000);

        // Demo scenario functions
        function triggerEquipmentFailure() {
            const event = {
                type: 'equipment_failure',
                data: { unit: 'ME6', impact: 'Production reduced to 70%' },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Update UI
            document.getElementById('plantStatus').textContent = 'Issue Detected';
            document.getElementById('plantStatus').className = 'card-status';
            document.getElementById('plantStatus').style.background = 'rgba(234, 88, 12, 0.1)';
            document.getElementById('plantStatus').style.color = 'var(--warning-orange)';
            
            document.getElementById('me6Output').textContent = '240 MT/day';
            document.getElementById('me6Status').textContent = 'Reduced Capacity';
            document.getElementById('me6Status').style.color = 'var(--warning-orange)';
            
            addTimelineEvent('‚öôÔ∏è', 'Production', 'ME6 equipment failure - Auto-response initiated');
            addAlert('‚ö†Ô∏è', 'Equipment Failure Detected', 'ME6 unit operating at reduced capacity - Backup systems activated');
            
            toggleDemoMenu();
        }

        function triggerBulkOrderSync() {
            const event = {
                type: 'bulk_order_sync',
                data: { orders: 15, total_mt: 4200 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Update UI
            const currentOrders = parseInt(document.getElementById('apacOrders').textContent);
            document.getElementById('apacOrders').textContent = (currentOrders + 15) + ' orders';
            addTimelineEvent('üìä', 'Sales', '15 bulk orders synced from SAP - 4,200 MT total');
            
            toggleDemoMenu();
        }

        function triggerSupplyChainAdjustment() {
            const event = {
                type: 'supply_chain_adjustment',
                data: { delay_days: 3, impact_mt: 850 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Update UI
            document.getElementById('shippingStatusText').textContent = 'Adjusted';
            addTimelineEvent('üîÑ', 'Supply Chain', 'Shipment schedule adjusted - 3 day delay mitigated');
            
            toggleDemoMenu();
        }

        function triggerGlobalRebalancing() {
            const event = {
                type: 'global_capacity_rebalancing',
                data: { from: 'Singapore', to: 'Mobile', mt: 1200 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Update UI
            const singaporeInv = parseFloat(document.getElementById('singaporeInventory').textContent);
            document.getElementById('singaporeInventory').textContent = (singaporeInv - 1.2).toFixed(1) + 'K MT';
            
            const mobileInv = parseFloat(document.getElementById('mobileInventory').textContent);
            document.getElementById('mobileInventory').textContent = (mobileInv + 1.2).toFixed(1) + 'K MT';
            
            addTimelineEvent('üåè', 'Global SC', 'Capacity rebalanced: 1,200 MT from Singapore to Mobile');
            
            toggleDemoMenu();
        }

        function resetDemo() {
            const event = {
                type: 'reset',
                data: {},
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            location.reload();
        }

        function broadcastEvent(event) {
            localStorage.setItem('evonik_coordination_event', JSON.stringify(event));
            setTimeout(() => localStorage.removeItem('evonik_coordination_event'), 100);
        }

        function addTimelineEvent(icon, source, text) {
            const timeline = document.getElementById('timelineList');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const item = document.createElement('li');
            item.className = 'timeline-item';
            item.innerHTML = `
                <div class="timeline-time">${timeStr}</div>
                <div class="timeline-content">
                    <span class="timeline-icon">${icon}</span>
                    <strong>${source}:</strong> ${text}
                </div>
            `;
            
            timeline.insertBefore(item, timeline.firstChild);
            
            while (timeline.children.length > 5) {
                timeline.removeChild(timeline.lastChild);
            }
        }

        function addAlert(icon, title, detail) {
            const alertsList = document.getElementById('alertsList');
            const alertCount = document.getElementById('alertCount');
            
            const item = document.createElement('li');
            item.className = 'alert-item';
            item.innerHTML = `
                <span class="alert-icon">${icon}</span>
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <div class="alert-detail">${detail}</div>
                </div>
            `;
            
            alertsList.insertBefore(item, alertsList.firstChild);
            
            const currentCount = parseInt(alertCount.textContent);
            alertCount.textContent = (currentCount + 1) + ' Active';
        }

        // User session handling
        function initializeUserSession() {
            const userSession = localStorage.getItem('evonik_user_session');
            if (!userSession) {
                // No session found, redirect to login
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const session = JSON.parse(userSession);
                updateUserDisplay(session);
                applyRoleBasedAccess(session);
            } catch (error) {
                console.error('Invalid session data:', error);
                localStorage.removeItem('evonik_user_session');
                window.location.href = 'login.html';
            }
        }
        
        function updateUserDisplay(session) {
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) {
                userDisplay.textContent = `${session.name} (${session.role.replace('_', ' ').toUpperCase()})`;
            }
        }
        
        function applyRoleBasedAccess(session) {
            const permissions = session.permissions;
            
            // Hide/show navigation items based on role
            const navItems = document.querySelectorAll('.stakeholder-btn');
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href) {
                    let dashboard = href.replace('-new.html', '').replace('.html', '');
                    
                    // Map specific dashboard names to permission names
                    const dashboardMapping = {
                        'global-supply-chain': 'global-sc',
                        'local-supply-chain': 'local-sc',
                        'optimizer': 'optimizer',
                        'sales': 'sales',
                        'production': 'production',
                        'index-new': 'hub'
                    };
                    
                    dashboard = dashboardMapping[dashboard] || dashboard;
                    
                    if (!permissions.dashboards.includes(dashboard)) {
                        item.style.display = 'none';
                    }
                }
            });
            
            // Apply role-specific styling or restrictions
            if (session.role === 'management') {
                document.body.classList.add('management-view');
            }
        }
        
        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserSession();
            
            // World map initialization
            const mapEl = document.getElementById('plantWorldMap');
            if (!mapEl) {
                console.error('Map element #plantWorldMap not found');
                return;
            }

            const map = L.map('plantWorldMap', { 
                zoomControl: true, 
                worldCopyJump: true 
            }).setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 8,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const plantCountries = {
                'Singapore': { 
                    color: '#8B2E8B', 
                    plants: [{ 
                        name: 'Jurong Island (ME5/ME6)', 
                        city: 'Singapore', 
                        lat: 1.3009, 
                        lon: 103.7876 
                    }] 
                },
                'Belgium': { 
                    color: '#8B2E8B', 
                    plants: [{ 
                        name: 'Antwerp Plant', 
                        city: 'Antwerp', 
                        lat: 51.2600, 
                        lon: 4.4020 
                    }] 
                },
                'United States of America': { 
                    color: '#8B2E8B', 
                    plants: [{ 
                        name: 'Mobile Plant', 
                        city: 'Mobile, Alabama', 
                        lat: 30.6954, 
                        lon: -88.0399 
                    }] 
                }
            };

            fetch('https://unpkg.com/geojson-world@1.0.0/countries.geo.json')
                .then(r => r.json())
                .then(geo => {
                    L.geoJSON(geo, {
                        style: feature => {
                            const name = feature.properties.name;
                            if (plantCountries[name]) {
                                return { 
                                    color: '#8B2E8B', 
                                    weight: 1, 
                                    fillColor: plantCountries[name].color, 
                                    fillOpacity: 0.25 
                                };
                            }
                            return { 
                                color: '#e5e7eb', 
                                weight: 1, 
                                fillColor: '#f8fafc', 
                                fillOpacity: 0.6 
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const name = feature.properties.name;
                            if (plantCountries[name]) {
                                const plants = plantCountries[name].plants
                                    .map(p => `<div><strong>${p.name}</strong><br/>üìç ${p.city}, ${name}</div>`)
                                    .join('');
                                layer.bindPopup(`<div style="min-width:220px"><strong>${name}</strong><br/>${plants}</div>`);
                                layer.on('mouseover', () => layer.setStyle({ fillOpacity: 0.4 }));
                                layer.on('mouseout', () => layer.setStyle({ fillOpacity: 0.25 }));
                            }
                        }
                    }).addTo(map);

                    // Add plant markers
                    const markers = [];
                    Object.entries(plantCountries).forEach(([country, cfg]) => {
                        cfg.plants.forEach(p => {
                            const marker = L.circleMarker([p.lat, p.lon], {
                                radius: 8,
                                color: '#FFFFFF',
                                weight: 2,
                                fillColor: '#8B2E8B',
                                fillOpacity: 0.95
                            })
                                .addTo(map)
                                .bindPopup(`<strong>${p.name}</strong><br/>${p.city}, ${country}`)
                                .bindTooltip(p.city, { permanent: false, direction: 'top' });
                            markers.push(marker);
                        });
                    });

                    // Fit map to show all markers
                    if (markers.length) {
                        const group = L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.5));
                    }
                })
                .catch(err => {
                    console.error('World GeoJSON failed to load:', err);
                    // Show user-friendly error message
                    const mapEl = document.getElementById('plantWorldMap');
                    if (mapEl) {
                        mapEl.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8fafc; color: #6B7280; text-align: center; padding: 2rem;">
                                <div>
                                    <div style="font-size: 2rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">Map Loading Error</div>
                                    <div style="font-size: 0.9rem;">Unable to load world map data. Please check your internet connection.</div>
                                </div>
                            </div>
                        `;
                    }
                });
        });

        // Listen for events from other pages
        window.addEventListener('storage', function(e) {
            if (e.key === 'evonik_coordination_event' && e.newValue) {
                const event = JSON.parse(e.newValue);
                console.log('Received coordination event:', event);
            }
        });
    </script>
</body>
</html>