<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="https://onsenix12.github.io/evonik-dashboard/">
    <title>AI Decision Optimizer - Evonik Methionine Production</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="shared-styles-new.css">
    <script src="shared-utils.js"></script>
    <script src="message-processor.js"></script>
    <style>
        /* Page-specific styles for optimizer.html */
        .header {
            background: linear-gradient(135deg, var(--evonik-purple) 0%, var(--evonik-dark-purple) 100%);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1600px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .ai-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .role-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .role-selector label {
            font-size: 0.9rem;
        }

        .role-selector select {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            background: white;
            color: var(--evonik-purple);
            font-weight: 500;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .container {
            display: flex;
            height: calc(100vh - 140px);
            max-width: 1600px;
            margin: 0 auto;
            gap: 1rem;
            padding: 1rem;
        }

        /* Chat Panel - Left */
        .chat-panel {
            width: 40%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--evonik-purple);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.system .message-avatar {
            background: linear-gradient(135deg, var(--evonik-purple), var(--evonik-light-purple));
            color: white;
        }

        .message.user .message-avatar {
            background: var(--border-gray);
            color: var(--text-dark);
        }

        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.system .message-bubble {
            background: var(--bg-gray);
            color: var(--text-dark);
            border: 1px solid var(--border-gray);
        }

        .message.user .message-bubble {
            background: var(--evonik-purple);
            color: white;
        }

        .message.alert .message-bubble {
            background: #FEF2F2;
            border: 2px solid var(--alert-red);
            color: var(--alert-red);
            font-weight: 500;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-light);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-gray);
            background: white;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 0.4rem 0.8rem;
            background: var(--bg-gray);
            border: 1px solid var(--border-gray);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: var(--evonik-light-purple);
            color: white;
            border-color: var(--evonik-light-purple);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--evonik-purple);
        }

        .send-btn {
            padding: 0.75rem 1.5rem;
            background: var(--evonik-purple);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .send-btn:hover {
            background: var(--evonik-dark-purple);
        }

        .send-btn:disabled {
            background: var(--border-gray);
            cursor: not-allowed;
        }

        /* Visualization Panel - Right */
        .viz-panel {
            width: 60%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viz-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viz-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .viz-timestamp {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .viz-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .viz-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            text-align: center;
        }

        .viz-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-gray);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-gray);
        }

        .metric-change {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .metric-change.positive { color: var(--success-green); }
        .metric-change.negative { color: var(--alert-red); }

        .scenario-card {
            background: var(--bg-gray);
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            animation: fadeIn 0.5s ease;
        }

        .scenario-card.recommended {
            border-color: var(--success-green);
            background: linear-gradient(to right, rgba(22, 163, 74, 0.05), var(--bg-gray));
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .scenario-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-recommended {
            background: var(--success-green);
            color: white;
        }

        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .scenario-metric {
            text-align: center;
        }

        .scenario-metric-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .scenario-metric-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .value-positive { color: var(--success-green); }
        .value-negative { color: var(--alert-red); }
        .value-neutral { color: var(--text-dark); }

        .explainability-panel {
            background: linear-gradient(to right, rgba(139, 46, 139, 0.05), white);
            border-left: 4px solid var(--evonik-purple);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .explainability-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--evonik-purple);
            margin-bottom: 1rem;
        }

        .explainability-reasons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .reason-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .reason-icon {
            width: 24px;
            height: 24px;
            background: var(--evonik-purple);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .reason-text {
            flex: 1;
            line-height: 1.5;
        }

        /* Estimation Methodology Styles */
        .estimation-methodology {
            background: white;
            border: 2px solid var(--evonik-purple);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-gray);
        }

        .method-header h4 {
            font-size: 1.3rem;
            color: var(--text-dark);
        }

        .confidence-badge {
            background: rgba(234, 88, 12, 0.1);
            color: var(--warning-orange);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .method-section {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-gray);
            border-radius: 8px;
        }

        .method-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .method-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .method-text {
            color: var(--text-light);
            line-height: 1.6;
        }

        .method-text ul {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }

        .method-text li {
            margin: 0.25rem 0;
        }

        .estimation-result {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-gray);
        }

        .result-box {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-gray);
            border-radius: 8px;
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--evonik-purple);
        }

        .result-subtext {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        /* User Validation Styles */
        .user-validation-panel {
            background: rgba(139, 46, 139, 0.05);
            border: 2px dashed var(--evonik-purple);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .validation-header h4 {
            color: var(--evonik-purple);
            font-size: 1.2rem;
        }

        .validation-form {
            margin: 1.5rem 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .form-input {
            padding: 0.75rem;
            border: 2px solid var(--border-gray);
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--evonik-purple);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-primary {
            background: var(--evonik-purple);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #6B1B6B;
        }

        .btn-secondary {
            background: white;
            color: var(--text-dark);
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-gray);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .validation-feedback {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success-green);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-weight: 600;
        }

        .validation-impact {
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
        }

        .validation-impact ul {
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }

        /* Equipment Criticality Styles */
        .equipment-status-section {
            margin: 2rem 0;
        }

        .equipment-list { margin-top: 1rem; }

        .equipment-item {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .equipment-item.critical {
            border-left-color: var(--alert-red);
            background: rgba(220, 38, 38, 0.05);
        }

        .equipment-item.important {
            border-left-color: var(--warning-orange);
            background: rgba(234, 88, 12, 0.05);
        }

        .equipment-item.normal {
            border-left-color: var(--success-green);
            background: rgba(22, 163, 74, 0.05);
        }

        .equipment-criticality {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .criticality-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .criticality-badge.critical { background: rgba(220, 38, 38, 0.2); color: var(--alert-red); }
        .criticality-badge.important { background: rgba(234, 88, 12, 0.2); color: var(--warning-orange); }
        .criticality-badge.normal { background: rgba(22, 163, 74, 0.2); color: var(--success-green); }

        .criticality-score { font-weight: 700; font-size: 1.1rem; }
        .equipment-name { font-size: 1.2rem; font-weight: 600; color: var(--text-dark); }
        .equipment-impact { color: var(--text-light); font-size: 0.9rem; }

        /* AI Reasoning Styles */
        .ai-reasoning-panel {
            background: linear-gradient(135deg, rgba(139, 46, 139, 0.05) 0%, rgba(139, 46, 139, 0.02) 100%);
            border: 2px solid var(--evonik-purple);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .reasoning-section {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .reasoning-section.primary { border-left-color: var(--success-green); background: rgba(22, 163, 74, 0.05); }
        .reasoning-section.secondary { border-left-color: var(--warning-orange); background: rgba(234, 88, 12, 0.05); }
        .reasoning-section.tertiary { border-left-color: var(--text-light); background: rgba(100, 116, 139, 0.05); }

        .reasoning-score { font-weight: 700; font-size: 1.1rem; color: var(--evonik-purple); margin: 0.5rem 0; }
        .reasoning-explanation { line-height: 1.8; }

        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .comparison-table th, .comparison-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-gray); }
        .comparison-table thead { background: var(--bg-gray); }
        .comparison-table .total-row { font-weight: 700; background: var(--bg-gray); border-top: 2px solid var(--evonik-purple); }
        .reasoning-footer { margin-top: 2rem; padding: 1.5rem; background: rgba(139, 46, 139, 0.1); border-radius: 8px; border-left: 4px solid var(--evonik-purple); }
        .reasoning-footer p { line-height: 1.8; color: var(--text-dark); }

        /* Explainability Section Styles */
        .explainability-section {
            background: linear-gradient(135deg, rgba(139, 46, 139, 0.05) 0%, rgba(139, 46, 139, 0.02) 100%);
            border: 2px solid var(--evonik-purple);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .explainability-section h4 {
            color: var(--evonik-purple);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .decision-tree {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid var(--evonik-purple);
        }

        .step {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            background: var(--bg-gray);
            border-radius: 6px;
            border-left: 3px solid var(--evonik-purple);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .step:first-child {
            background: rgba(22, 163, 74, 0.1);
            border-left-color: var(--success-green);
        }

        .step:nth-child(2) {
            background: rgba(234, 88, 12, 0.1);
            border-left-color: var(--warning-orange);
        }

        .step:nth-child(3) {
            background: rgba(37, 99, 235, 0.1);
            border-left-color: var(--sales-blue);
        }

        .step:last-child {
            background: rgba(139, 46, 139, 0.1);
            border-left-color: var(--evonik-purple);
            font-weight: 600;
        }

        .compare-button {
            background: linear-gradient(135deg, var(--evonik-purple), var(--evonik-light-purple));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .compare-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 46, 139, 0.4);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>AI Decision Optimizer</h1>
                <div class="ai-badge">
                    <span>ü§ñ</span>
                    <span>Layer 3: Intelligent Decision Engine</span>
                </div>
            </div>
        </div>
        <div class="nav-links">
            <a href="index-new.html" class="nav-link">‚Üê Coordination Dashboard</a>
        </div>
    </div>

    <div class="container">
        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>Conversational AI Assistant</h2>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>Online</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="chat-input-container">
                <div class="quick-actions" id="quickActions">
                    <button class="quick-action-btn" onclick="sendQuickMessage('Show current production status')">üìä Production Status</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('What are my tank levels?')">üõ¢Ô∏è Tank Levels</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Show production costs')">üí∞ Cost Analysis</button>
                    <button class="quick-action-btn" onclick="triggerCrisis('equipment_failure')" style="background: #FEF2F2; border-color: #DC2626; color: #DC2626;">‚ö†Ô∏è Equipment Failure</button>
                    <button class="quick-action-btn" onclick="triggerCrisis('supply_delay')" style="background: #FEF2F2; border-color: #DC2626; color: #DC2626;">üöö Supply Delay</button>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything about your production planning..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Visualization Panel -->
        <div class="viz-panel">
            <div class="viz-header">
                <div class="viz-title" id="vizTitle">Production Overview</div>
                <div class="viz-timestamp" id="vizTimestamp">Live Data</div>
            </div>
            <div class="viz-content" id="vizContent">
                <div class="viz-placeholder">
                    <div class="viz-placeholder-icon">üìä</div>
                    <h3>Ask me a question to get started</h3>
                    <p>I can show you production metrics, tank levels, cost analysis, and optimization scenarios</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentRole = 'local_sc';
        let conversationState = 'initial';
        let messageCount = 0;
        let crisisTriggered = false;
        let crisisAlreadyTriggered = false; // Prevent multiple crisis triggers
        let currentScenarioType = 'equipment_failure'; // 'equipment_failure' or 'supply_delay'

        // Role-specific contexts
        const roleContexts = {
            local_sc: {
                name: 'Local SC Manager',
                focus: 'inventory management, raw materials, SAP-Excel automation',
                greeting: 'Hello! I can help you with production planning, inventory optimization, and raw material coordination.'
            },
            plant: {
                name: 'Plant Manager',
                focus: 'equipment status, maintenance schedules, capacity utilization',
                greeting: 'Hello! I can help you with production capacity, equipment performance, and maintenance planning.'
            },
            sales: {
                name: 'Sales Team',
                focus: 'order fulfillment, customer impact, shipment planning',
                greeting: 'Hello! I can help you with order fulfillment forecasts, customer allocation, and demand planning.'
            },
            global_sc: {
                name: 'Global Supply Chain',
                focus: 'cross-plant coordination, global inventory, strategic allocation',
                greeting: 'Hello! I can help you with global coordination, multi-site optimization, and strategic planning.'
            }
        };

        // Scenario-specific data models
        const scenarioData = {
            equipment_failure: {
                name: "Equipment Failure",
                description: "ME6 unit offline - PIMS sensor detection",
                impact: {
                    productionReduction: 345, // MT/day
                    downtime: "3-5 days",
                    totalShortfall: "1,035-1,725 MT",
                    affectedUnit: "ME6",
                    detectionTime: "Oct 23, 2025 14:23"
                },
                scenarios: [
                    {
                        id: "A",
                        title: "Increase ME5 Production",
                        description: "Increase ME5 unit capacity by 20% to compensate for ME6 shutdown",
                        costImpact: -25000,
                        timeline: "Immediate",
                        riskLevel: "Low",
                        details: {
                            increasedUtilities: 95000,
                            avoidedShortagePenalty: -120000,
                            netSavings: 25000
                        }
                    },
                    {
                        id: "B", 
                        title: "Divert to Malaysia Plant",
                        description: "Transfer production allocation to Malaysia facility",
                        costImpact: 60000,
                        timeline: "3 days",
                        riskLevel: "Medium",
                        details: {
                            transferLogistics: 180000,
                            avoidedShortagePenalty: -120000,
                            netCost: 60000
                        }
                    },
                    {
                        id: "C",
                        title: "Defer Customer Shipments", 
                        description: "Negotiate shipment delays with customers using tank inventory buffer",
                        costImpact: -30000,
                        timeline: "2 days",
                        riskLevel: "High",
                        details: {
                            demurrageFees: 90000,
                            avoidedShortagePenalty: -120000,
                            netSavings: 30000,
                            customerRisk: true
                        }
                    }
                ]
            },
            supply_delay: {
                name: "Supply Delay",
                description: "Critical raw material delivery delayed - H2 supply disruption",
                impact: {
                    productionReduction: 200, // MT/day
                    downtime: "2-4 days", 
                    totalShortfall: "400-800 MT",
                    affectedMaterial: "H2 (Hydrogen)",
                    detectionTime: "Oct 23, 2025 11:15"
                },
                scenarios: [
                    {
                        id: "A",
                        title: "Activate Emergency H2 Reserves",
                        description: "Use emergency hydrogen reserves and expedite alternative supplier",
                        costImpact: -15000,
                        timeline: "Immediate",
                        riskLevel: "Low",
                        details: {
                            emergencyReserveCost: 25000,
                            expeditedSupplier: 40000,
                            avoidedShortagePenalty: -80000,
                            netSavings: 15000
                        }
                    },
                    {
                        id: "B",
                        title: "Reduce Production Rate",
                        description: "Temporarily reduce ME5/ME6 production to 80% capacity",
                        costImpact: 35000,
                        timeline: "Immediate", 
                        riskLevel: "Medium",
                        details: {
                            productionLoss: 115000,
                            avoidedShortagePenalty: -80000,
                            netCost: 35000
                        }
                    },
                    {
                        id: "C",
                        title: "Switch to Alternative Feedstock",
                        description: "Temporarily use alternative H2 source with quality adjustments",
                        costImpact: 50000,
                        timeline: "1 day",
                        riskLevel: "High",
                        details: {
                            alternativeFeedstock: 130000,
                            avoidedShortagePenalty: -80000,
                            netCost: 50000,
                            qualityRisk: true
                        }
                    }
                ]
            }
        };

        // Current operational data (aligned with other dashboards) - November 2025
        const operationalData = {
            production: {
                monthlyTarget: 29000,
                currentProduction: 24150, // Updated for November
                dailyOutput: 965,
                me5Output: 620,
                me6Output: 345,
                me5MaxCapacity: 775,
                me6MaxCapacity: 430,
                dailyProduction: [945, 972, 958, 961, 967, 955, 970, 968, 960, 964, 959, 961, 966, 969, 974], // Last 15 days
                oeeTrend: Array.from({length: 30}, () => 94.2 + Math.random() * 2 - 1),
                hourlyProduction: Array.from({length: 24}, (_, i) => {
                    const baseHourly = 40.2;
                    const hour = i;
                    if (hour >= 0 && hour < 6) return baseHourly * 0.85 + Math.random() * 3;
                    if (hour >= 8 && hour < 18) return baseHourly * 1.05 + Math.random() * 4;
                    return baseHourly + Math.random() * 3;
                }),
                qualityRate: Array.from({length: 30}, () => 98.5 + Math.random() * 0.8 - 0.4)
            },
            inventory: {
                tankLevel: 4200,
                tankCapacity: 6300,
                safeRange: { min: 3000, max: 6000 },
                mitsuiAllocation: 600,
                akemaAllocation: 0,
                heelStock: 836,
                dailyShipments: [820, 850, 790, 865, 910, 880, 782, 795, 810, 845, 870, 890, 825, 850],
                monthlyShipped: 24150
            },
            costs: {
                dailyCost: 78.5,
                monthlyActual: 2.35, // Updated for November
                monthlyBudget: 2.4,
                costPerMT: 102,
                weeklyCosts: [562, 548, 595, 520], // Last 4 weeks
                costBreakdown: {
                    rawMaterials: 45,
                    utilities: 28,
                    labor: 15,
                    maintenance: 8,
                    other: 4
                }
            },
            rawMaterials: {
                h2: { stock: 4800, consumption: 85, leadTime: 14, trend: Array.from({length: 30}, () => 4800 + Math.random() * 200) },
                mmp: { stock: 1850, consumption: 42, leadTime: 21, trend: Array.from({length: 30}, () => 1850 + Math.random() * 100) },
                methanol: { stock: 980, consumption: 38, leadTime: 18, trend: Array.from({length: 30}, () => 980 - Math.random() * 50) }
            },
            equipment: {
                me5: {
                    utilization: 80,
                    oee: 94.5,
                    temperature: 138,
                    pressure: 2.1,
                    flowRate: 42,
                    vibration: 1.8
                },
                me6: {
                    utilization: 80,
                    oee: 93.8,
                    temperature: 139,
                    pressure: 2.15,
                    flowRate: 38,
                    vibration: 1.9
                }
            }
        };

        // Initialize chat
        function initChat() {
            const greeting = roleContexts[currentRole].greeting;
            addSystemMessage(greeting);
            addSystemMessage('Current SAP sync: Active, last sync 2 min ago. I have access to real-time data from SAP, PIMS, and IBP systems. What would you like to know?');
        }

        // Add message functions
        function addSystemMessage(text, isAlert = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message system ${isAlert ? 'alert' : ''}`;
            messageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">${text}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addUserMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">üë§</div>
                <div class="message-bubble">${text}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message system';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        // Handle user input
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addUserMessage(message);
            input.value = '';
            messageCount++;

            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                processMessage(message);
            }, 1500);
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Store reference to module function before defining wrapper
        const processMessageModule = typeof window !== 'undefined' && window.processMessageModule ? window.processMessageModule : null;

        // Process messages using message-processor.js module
        function processMessage(message) {
            // Set up handlers object
            const handlers = {
                showScenarioAMethodology,
                showValidationForm,
                showEquipmentStatus,
                showScenarioB,
                showScenarioC,
                showProductionStatus,
                showTankLevels,
                showCostAnalysis,
                showScenarios,
                showExplainability,
                addSystemMessage
            };

            // Set up state object
            const state = {
                crisisTriggered,
                shownSections
            };

            // Use module function if available
            if (processMessageModule && typeof processMessageModule === 'function') {
                processMessageModule(message, handlers, state);
                return;
            }

            // Fallback: Simple message routing
            const lowerMsg = message.toLowerCase();
            if (lowerMsg.includes('production') || lowerMsg.includes('status') || lowerMsg.includes('output')) {
                showProductionStatus();
            } else if (lowerMsg.includes('tank') || lowerMsg.includes('inventory') || lowerMsg.includes('stock') || lowerMsg.includes('level')) {
                showTankLevels();
            } else {
                addSystemMessage('I can help you with: production status, tank levels, cost analysis, and optimization scenarios. What would you like to explore?');
            }
        }

        // UPDATED: Optimization weights based on Michael's feedback
        const OPTIMIZATION_WEIGHTS = {
            customerImpact: 0.70,    // PRIMARY: Minimize customer delay
            costEfficiency: 0.25,     // SECONDARY: Cost considerations
            speedOfResolution: 0.05   // TERTIARY: How fast we can respond
        };

        // Calculate scenario score
        function calculateScenarioScore(scenario) {
            const customerScore = calculateCustomerImpactScore(scenario);
            const costScore = calculateCostEfficiencyScore(scenario);
            const speedScore = calculateSpeedScore(scenario);
            const totalScore = (
                customerScore * OPTIMIZATION_WEIGHTS.customerImpact +
                costScore * OPTIMIZATION_WEIGHTS.costEfficiency +
                speedScore * OPTIMIZATION_WEIGHTS.speedOfResolution
            );
            return {
                total: totalScore,
                breakdown: { customer: customerScore, cost: costScore, speed: speedScore }
            };
        }

        // Customer Impact Calculation
        function calculateCustomerImpactScore(scenario) {
            const maxDelay = 5; // days - worst case scenario
            const scenarioDelay = scenario.customerDelay || 0;
            if (scenarioDelay === 0) return 100;
            return Math.max(0, 100 - (scenarioDelay / maxDelay * 100));
        }

        // Cost Efficiency Calculation (lower cost = higher score)
        function calculateCostEfficiencyScore(scenario) {
            const maxCost = 60000; // normalize against highest expected
            const cost = Math.min(Math.abs(scenario.costImpact || 0), maxCost);
            return Math.max(0, 100 - (cost / maxCost * 100));
        }

        // Speed Score (faster resolution = higher score)
        function calculateSpeedScore(scenario) {
            const maxTime = 5; // days
            const time = Math.min(scenario.resolutionTime || 0, maxTime);
            return Math.max(0, 100 - (time / maxTime * 100));
        }

        // Example scenarios with new scoring
        const scenariosData = {
            scenarioA: {
                name: "Immediate External Production Activation",
                customerDelay: 0,
                costImpact: 45000,
                resolutionTime: 1,
                description: "Activate Antwerp plant immediately to cover Singapore shortfall"
            },
            scenarioB: {
                name: "Wait for Repair + Expedited Shipping",
                customerDelay: 2,
                costImpact: 30000,
                resolutionTime: 4,
                description: "Wait for MV-6 repair, then expedite customer shipments"
            },
            scenarioC: {
                name: "Standard Repair Process",
                customerDelay: 4,
                costImpact: 15000,
                resolutionTime: 5,
                description: "Standard repair timeline with buffer inventory"
            }
        };

        // Visualization functions
        function showProductionStatus() {
            addSystemMessage('Here is your current production status for November 2025:');
            updateVizTitle('Production Status - ME5 & ME6 Units');
            
            const data = operationalData.production;
            const progress = Math.round((data.currentProduction / data.monthlyTarget) * 100);
            const daysElapsed = Math.floor(data.currentProduction / data.dailyOutput);
            const daysRemaining = 30 - daysElapsed;
            const projectedEnd = data.currentProduction + (daysRemaining * data.dailyOutput);
            
            // Generate daily labels for last 15 days
            const dailyLabels = Array.from({length: 15}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (14 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const content = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Monthly Target</div>
                        <div class="metric-value">${data.monthlyTarget.toLocaleString()} MT</div>
                        <div class="metric-change positive">‚ñ≤ On track</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Current Production</div>
                        <div class="metric-value">${data.currentProduction.toLocaleString()} MT</div>
                        <div class="metric-change positive">‚ñ≤ ${progress}% complete</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Daily Average</div>
                        <div class="metric-value">${data.dailyOutput} MT/day</div>
                        <div class="metric-change positive">‚ñ≤ Above baseline</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Projected Month End</div>
                        <div class="metric-value">${Math.round(projectedEnd).toLocaleString()} MT</div>
                        <div class="metric-change ${projectedEnd >= data.monthlyTarget ? 'positive' : 'negative'}">${projectedEnd >= data.monthlyTarget ? '‚ñ≤' : '‚ñº'} ${Math.round((projectedEnd / data.monthlyTarget) * 100)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ME5 Output</div>
                        <div class="metric-value">${data.me5Output} MT/day</div>
                        <div class="metric-change positive">‚ñ≤ ${Math.round((data.me5Output / data.me5MaxCapacity) * 100)}% capacity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ME6 Output</div>
                        <div class="metric-value">${data.me6Output} MT/day</div>
                        <div class="metric-change positive">‚ñ≤ ${Math.round((data.me6Output / data.me6MaxCapacity) * 100)}% capacity</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìä Weekly Production Performance</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="weeklyProductionChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìà Daily Production Trend (Last 15 Days)</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="dailyProductionChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">‚öôÔ∏è Equipment Performance</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="equipmentChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìâ OEE Trend (Last 30 Days)</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="oeeChart"></canvas>
                    </div>
                </div>
                
                <div style="padding: 1rem; background: rgba(139, 46, 139, 0.05); border-left: 4px solid var(--evonik-purple); border-radius: 8px; margin-top: 1rem;">
                    <strong>Key Insights:</strong><br>
                    ‚Ä¢ Production is ${progress}% complete with ${daysRemaining} days remaining<br>
                    ‚Ä¢ Average OEE: ${Math.round(operationalData.production.oeeTrend.slice(-7).reduce((a,b) => a+b, 0) / 7)}% (last 7 days)<br>
                    ‚Ä¢ Quality rate: ${Math.round(operationalData.production.qualityRate.slice(-7).reduce((a,b) => a+b, 0) / 7)}%<br>
                    ‚Ä¢ Both ME5 and ME6 operating within optimal capacity ranges
                </div>
            `;
            
            document.getElementById('vizContent').innerHTML = content;
            
            // Weekly Production Chart
            const weeklyCtx = document.getElementById('weeklyProductionChart').getContext('2d');
            new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4 (Projected)'],
                    datasets: [
                        {
                            label: 'Forecasted',
                            data: [7250, 7250, 7250, 7250],
                            backgroundColor: 'rgba(139, 46, 139, 0.2)',
                            borderColor: 'rgba(139, 46, 139, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Actual',
                            data: [7340, 7180, 8100, Math.round((projectedEnd - 24150) / 4)],
                            backgroundColor: 'rgba(22, 163, 74, 0.6)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Monthly Production Performance (MT)' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Metric Tons (MT)' }
                        }
                    }
                }
            });
            
            // Daily Production Trend
            const dailyCtx = document.getElementById('dailyProductionChart').getContext('2d');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [
                        {
                            label: 'Daily Production (MT)',
                            data: data.dailyProduction,
                            borderColor: 'rgba(139, 46, 139, 1)',
                            backgroundColor: 'rgba(139, 46, 139, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4
                        },
                        {
                            label: 'Target (965 MT/day)',
                            data: Array(15).fill(965),
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 920,
                            max: 1000,
                            title: { display: true, text: 'Production (MT/day)' }
                        }
                    }
                }
            });
            
            // Equipment Performance
            const equipCtx = document.getElementById('equipmentChart').getContext('2d');
            new Chart(equipCtx, {
                type: 'bar',
                data: {
                    labels: ['ME5', 'ME6'],
                    datasets: [
                        {
                            label: 'Current Output (MT/day)',
                            data: [data.me5Output, data.me6Output],
                            backgroundColor: 'rgba(139, 46, 139, 0.6)',
                            borderColor: 'rgba(139, 46, 139, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Max Capacity (MT/day)',
                            data: [data.me5MaxCapacity, data.me6MaxCapacity],
                            backgroundColor: 'rgba(168, 85, 247, 0.3)',
                            borderColor: 'rgba(168, 85, 247, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Output (MT/day)' }
                        }
                    }
                }
            });
            
            // OEE Trend
            const oeeCtx = document.getElementById('oeeChart').getContext('2d');
            const oeeLabels = Array.from({length: 30}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            new Chart(oeeCtx, {
                type: 'line',
                data: {
                    labels: oeeLabels,
                    datasets: [{
                        label: 'OEE (%)',
                        data: data.oeeTrend,
                        borderColor: 'rgba(22, 163, 74, 1)',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 90,
                            max: 98,
                            title: { display: true, text: 'OEE (%)' }
                        }
                    }
                }
            });
        }

        function showTankLevels() {
            addSystemMessage('Current tank inventory status:');
            updateVizTitle('Tank Capacity & Inventory Levels');
            
            const data = operationalData.inventory;
            const utilization = Math.round((data.tankLevel / data.tankCapacity) * 100);
            const availableSpace = data.tankCapacity - data.tankLevel;
            const daysCoverage = Math.round(data.tankLevel / operationalData.production.dailyOutput);
            const freeStock = data.tankLevel - data.mitsuiAllocation - data.heelStock;
            
            // Generate trend data for last 30 days
            const trendLabels = Array.from({length: 30}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const inventoryTrend = Array.from({length: 30}, (_, i) => {
                // Simulate realistic inventory trend
                const base = 4200;
                const variation = Math.sin(i / 5) * 200 + Math.random() * 100 - 50;
                return Math.max(3000, Math.min(6000, base + variation));
            });
            
            const content = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Current Inventory</div>
                        <div class="metric-value">${data.tankLevel.toLocaleString()} MT</div>
                        <div class="metric-change positive">‚ñ≤ Safe zone (${data.safeRange.min}K-${data.safeRange.max}K)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Tank Capacity</div>
                        <div class="metric-value">${data.tankCapacity.toLocaleString()} MT</div>
                        <div class="metric-change neutral">${utilization}% utilized</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Available Space</div>
                        <div class="metric-value">${availableSpace.toLocaleString()} MT</div>
                        <div class="metric-change positive">‚ñ≤ ${Math.round((availableSpace / data.tankCapacity) * 100)}% buffer</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Days Coverage</div>
                        <div class="metric-value">${daysCoverage} days</div>
                        <div class="metric-change positive">‚ñ≤ At current production rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Free Stock</div>
                        <div class="metric-value">${freeStock.toLocaleString()} MT</div>
                        <div class="metric-change neutral">Available for allocation</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Monthly Shipped</div>
                        <div class="metric-value">${data.monthlyShipped.toLocaleString()} MT</div>
                        <div class="metric-change positive">‚ñ≤ November 2025</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üõ¢Ô∏è Tank Distribution</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="tankChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìà Inventory Trend (Last 30 Days)</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="inventoryTrendChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üì¶ Daily Shipments vs Production</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="shipmentChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: rgba(22, 163, 74, 0.1); border-left: 4px solid #16A34A; border-radius: 8px;">
                    <strong>Co-mingled Inventory Details:</strong><br>
                    ‚Ä¢ Mitsui Allocation: ${data.mitsuiAllocation} MT<br>
                    ‚Ä¢ Akema Allocation: ${data.akemaAllocation} MT<br>
                    ‚Ä¢ Working Capacity Max: ${data.tankCapacity.toLocaleString()} MT<br>
                    ‚Ä¢ Combined Heel Stock: ${data.heelStock} MT<br>
                    ‚Ä¢ Free Stock Available: ${freeStock.toLocaleString()} MT
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(139, 46, 139, 0.05); border-left: 4px solid var(--evonik-purple); border-radius: 8px;">
                    <strong>Inventory Health:</strong><br>
                    ‚Ä¢ Current level: ${utilization}% of capacity (${utilization >= 50 && utilization <= 90 ? 'Optimal' : utilization < 50 ? 'Low - Consider increasing' : 'High - Monitor closely'})<br>
                    ‚Ä¢ Coverage: ${daysCoverage} days at current production rate (${daysCoverage >= 5 ? 'Sufficient buffer' : 'Low buffer - monitor'})<br>
                    ‚Ä¢ Safe range: ${data.safeRange.min.toLocaleString()} - ${data.safeRange.max.toLocaleString()} MT
                </div>
            `;
            
            document.getElementById('vizContent').innerHTML = content;
            
            // Tank Distribution Chart
            const ctx = document.getElementById('tankChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Free Stock', 'Mitsui Allocation', 'Heel Stock', 'Available Capacity'],
                    datasets: [{
                        data: [freeStock, data.mitsuiAllocation, data.heelStock, availableSpace],
                        backgroundColor: [
                            'rgba(139, 46, 139, 0.8)',
                            'rgba(168, 85, 247, 0.6)',
                            'rgba(234, 88, 12, 0.6)',
                            'rgba(229, 231, 235, 0.5)'
                        ],
                        borderColor: [
                            'rgba(139, 46, 139, 1)',
                            'rgba(168, 85, 247, 1)',
                            'rgba(234, 88, 12, 1)',
                            'rgba(229, 231, 235, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Tank Distribution (Total: 6,300 MT)' }
                    }
                }
            });
            
            // Inventory Trend Chart
            const trendCtx = document.getElementById('inventoryTrendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [
                        {
                            label: 'Inventory Level (MT)',
                            data: inventoryTrend,
                            borderColor: 'rgba(139, 46, 139, 1)',
                            backgroundColor: 'rgba(139, 46, 139, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        },
                        {
                            label: 'Safe Range Min',
                            data: Array(30).fill(data.safeRange.min),
                            borderColor: 'rgba(234, 88, 12, 1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Safe Range Max',
                            data: Array(30).fill(data.safeRange.max),
                            borderColor: 'rgba(234, 88, 12, 1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 2500,
                            max: 6500,
                            title: { display: true, text: 'Inventory (MT)' }
                        }
                    }
                }
            });
            
            // Shipments vs Production Chart
            const shipmentCtx = document.getElementById('shipmentChart').getContext('2d');
            const shipmentLabels = Array.from({length: 14}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (13 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            new Chart(shipmentCtx, {
                type: 'line',
                data: {
                    labels: shipmentLabels,
                    datasets: [
                        {
                            label: 'Daily Shipments (MT)',
                            data: data.dailyShipments,
                            borderColor: 'rgba(234, 88, 12, 1)',
                            backgroundColor: 'rgba(234, 88, 12, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Daily Production (MT)',
                            data: data.dailyShipments.map((_, i) => operationalData.production.dailyProduction[Math.min(i, operationalData.production.dailyProduction.length - 1)]),
                            borderColor: 'rgba(22, 163, 74, 1)',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Target (965 MT/day)',
                            data: Array(14).fill(965),
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 700,
                            max: 1000,
                            title: { display: true, text: 'Volume (MT)' }
                        }
                    }
                }
            });
        }

        function showCostAnalysis() {
            addSystemMessage('Here is your production cost analysis for November 2025:');
            updateVizTitle('Production Cost Analysis');
            
            const data = operationalData.costs;
            const savings = data.monthlyBudget - data.monthlyActual;
            const savingsPercent = Math.round((savings / data.monthlyBudget) * 100);
            const costBreakdown = data.costBreakdown;
            const totalBreakdown = Object.values(costBreakdown).reduce((a, b) => a + b, 0);
            
            const content = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Production Cost</div>
                        <div class="metric-value">$${data.monthlyActual}M</div>
                        <div class="metric-change positive">‚ñº ${savingsPercent}% vs budget</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cost per MT</div>
                        <div class="metric-value">$${data.costPerMT}</div>
                        <div class="metric-change positive">‚ñº Optimized</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Daily Cost</div>
                        <div class="metric-value">$${data.dailyCost}K</div>
                        <div class="metric-change positive">‚ñ≤ Within budget</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Budget Variance</div>
                        <div class="metric-value">$${Math.abs(savings).toFixed(2)}M</div>
                        <div class="metric-change positive">‚ñº Under budget</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Monthly Budget</div>
                        <div class="metric-value">$${data.monthlyBudget}M</div>
                        <div class="metric-change neutral">Target</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cost Efficiency</div>
                        <div class="metric-value">${Math.round((data.monthlyBudget / data.monthlyActual) * 100)}%</div>
                        <div class="metric-change positive">‚ñ≤ Above target</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üí∞ Weekly Cost Trends</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="costChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìä Cost Breakdown by Category</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="costBreakdownChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">üìà Cost per MT Trend</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="costPerMTChart"></canvas>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 2rem;">
                    <div style="padding: 1rem; background: rgba(139, 46, 139, 0.05); border-left: 4px solid var(--evonik-purple); border-radius: 8px;">
                        <strong>Cost Breakdown (per $100):</strong><br>
                        ‚Ä¢ Raw Materials: $${costBreakdown.rawMaterials} (${Math.round((costBreakdown.rawMaterials / totalBreakdown) * 100)}%)<br>
                        ‚Ä¢ Utilities: $${costBreakdown.utilities} (${Math.round((costBreakdown.utilities / totalBreakdown) * 100)}%)<br>
                        ‚Ä¢ Labor: $${costBreakdown.labor} (${Math.round((costBreakdown.labor / totalBreakdown) * 100)}%)<br>
                        ‚Ä¢ Maintenance: $${costBreakdown.maintenance} (${Math.round((costBreakdown.maintenance / totalBreakdown) * 100)}%)<br>
                        ‚Ä¢ Other: $${costBreakdown.other} (${Math.round((costBreakdown.other / totalBreakdown) * 100)}%)
                    </div>
                    <div style="padding: 1rem; background: rgba(22, 163, 74, 0.1); border-left: 4px solid #16A34A; border-radius: 8px;">
                        <strong>Cost Performance:</strong><br>
                        ‚Ä¢ Budget utilization: ${Math.round((data.monthlyActual / data.monthlyBudget) * 100)}%<br>
                        ‚Ä¢ Savings achieved: $${savings.toFixed(2)}M (${savingsPercent}%)<br>
                        ‚Ä¢ Cost per MT: $${data.costPerMT} (target: $105)<br>
                        ‚Ä¢ Daily average: $${data.dailyCost}K/day<br>
                        ‚Ä¢ Status: ${savings > 0 ? 'Under budget ‚úì' : 'Over budget'}
                    </div>
                </div>
            `;
            
            document.getElementById('vizContent').innerHTML = content;
            
            // Weekly Cost Chart
            const ctx = document.getElementById('costChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Forecasted Cost',
                            data: [575, 575, 575, 575],
                            borderColor: 'rgba(234, 88, 12, 1)',
                            backgroundColor: 'rgba(234, 88, 12, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Actual Cost',
                            data: data.weeklyCosts,
                            borderColor: 'rgba(22, 163, 74, 1)',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Budget Target',
                            data: [600, 600, 600, 600],
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Weekly Production Cost Trends ($K)' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 500,
                            max: 650,
                            title: { display: true, text: 'Cost ($K)' }
                        }
                    }
                }
            });
            
            // Cost Breakdown Chart
            const breakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Raw Materials', 'Utilities', 'Labor', 'Maintenance', 'Other'],
                    datasets: [{
                        data: [
                            costBreakdown.rawMaterials,
                            costBreakdown.utilities,
                            costBreakdown.labor,
                            costBreakdown.maintenance,
                            costBreakdown.other
                        ],
                        backgroundColor: [
                            'rgba(139, 46, 139, 0.8)',
                            'rgba(234, 88, 12, 0.8)',
                            'rgba(37, 99, 235, 0.8)',
                            'rgba(22, 163, 74, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ],
                        borderColor: [
                            'rgba(139, 46, 139, 1)',
                            'rgba(234, 88, 12, 1)',
                            'rgba(37, 99, 235, 1)',
                            'rgba(22, 163, 74, 1)',
                            'rgba(168, 85, 247, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Cost Distribution (%)' }
                    }
                }
            });
            
            // Cost per MT Trend
            const costPerMTCtx = document.getElementById('costPerMTChart').getContext('2d');
            const costPerMTLabels = Array.from({length: 30}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const costPerMTData = Array.from({length: 30}, () => {
                // Simulate cost per MT trend (target: $102, range: $98-$106)
                return 102 + Math.random() * 4 - 2;
            });
            new Chart(costPerMTCtx, {
                type: 'line',
                data: {
                    labels: costPerMTLabels,
                    datasets: [
                        {
                            label: 'Cost per MT ($)',
                            data: costPerMTData,
                            borderColor: 'rgba(139, 46, 139, 1)',
                            backgroundColor: 'rgba(139, 46, 139, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        },
                        {
                            label: 'Target ($102)',
                            data: Array(30).fill(102),
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Budget Limit ($105)',
                            data: Array(30).fill(105),
                            borderColor: 'rgba(234, 88, 12, 1)',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 95,
                            max: 110,
                            title: { display: true, text: 'Cost per MT ($)' }
                        }
                    }
                }
            });
        }

        // Crisis trigger
        function triggerCrisis(scenarioType = null) {
            crisisTriggered = true;
            crisisAlreadyTriggered = true; // Prevent multiple triggers
            conversationState = 'crisis';
            
            // Set scenario type if provided
            if (scenarioType) {
                currentScenarioType = scenarioType;
                const selector = document.getElementById('scenarioSelector');
                if (selector) {
                    selector.value = scenarioType;
                }
            }
            
            // Hide quick actions during crisis
            const quickActions = document.getElementById('quickActions');
            if (quickActions) {
                quickActions.style.display = 'none';
            }
            
            // Clear any existing messages
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            const scenario = scenarioData[currentScenarioType];
            addSystemMessage(`‚ö†Ô∏è ALERT: ${scenario.description}. Analyzing production impact...`, true);
            
            setTimeout(() => {
                showCrisisImpact();
            }, 2000);
        }

        function showCrisisImpact() {
            const scenario = scenarioData[currentScenarioType];
            const impact = scenario.impact;
            
            addSystemMessage(`Impact analysis complete. ${scenario.name} will reduce daily production by ${impact.productionReduction} MT. Estimated downtime: ${impact.downtime}.`);
            updateVizTitle(`‚ö†Ô∏è Crisis Impact Analysis - ${scenario.name}`);
            
            const content = `
                <div style="background: #FEF2F2; border: 2px solid #DC2626; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 style="color: #DC2626; margin-bottom: 1rem;">‚ö†Ô∏è ${scenario.name} Alert</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div>
                            <strong>${currentScenarioType === 'equipment_failure' ? 'Equipment' : 'Material'}:</strong> ${currentScenarioType === 'equipment_failure' ? impact.affectedUnit : impact.affectedMaterial}<br>
                            <strong>Status:</strong> ${currentScenarioType === 'equipment_failure' ? 'Offline' : 'Delayed'}<br>
                            <strong>Time:</strong> ${impact.detectionTime}
                        </div>
                        <div>
                            <strong>Estimated Downtime:</strong> ${impact.downtime}<br>
                            <strong>Production Impact:</strong> -${impact.productionReduction} MT/day<br>
                            <strong>Total Shortfall:</strong> ${impact.totalShortfall}
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="impactChart"></canvas>
                </div>
                <div style="margin-top: 2rem; padding: 1rem; background: rgba(139, 46, 139, 0.1); border-left: 4px solid #8B2E8B; border-radius: 8px;">
                    <strong>Current Situation:</strong><br>
                    ‚Ä¢ Daily target: 965 MT ‚Üí Reduced to ${965 - impact.productionReduction} MT<br>
                    ‚Ä¢ Monthly forecast at risk: 78% ‚Üí ${Math.round(78 - (impact.productionReduction/965)*100)}% projected<br>
                    ‚Ä¢ Customer commitments may be impacted<br>
                    ‚Ä¢ Tank inventory buffer: 4,200 MT (6.8 days coverage)
                </div>
            `;
            
            document.getElementById('vizContent').innerHTML = content;
            
            // Create impact chart with scenario-specific data
            const ctx = document.getElementById('impactChart').getContext('2d');
            const beforeValue = 965;
            const duringValue = beforeValue - impact.productionReduction;
            const recoveryValue = beforeValue - Math.round(impact.productionReduction * 0.3);
            
            // Destroy existing chart if it exists
            if (impactChartInstance) {
                impactChartInstance.destroy();
            }
            
            impactChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Before Crisis', 'During Crisis', 'Recovery Period'],
                    datasets: [
                        {
                            label: 'Daily Production (MT)',
                            data: [beforeValue, duringValue, recoveryValue],
                            backgroundColor: [
                                'rgba(22, 163, 74, 0.6)',
                                'rgba(220, 38, 38, 0.6)',
                                'rgba(234, 88, 12, 0.6)'
                            ],
                            borderColor: [
                                'rgba(22, 163, 74, 1)',
                                'rgba(220, 38, 38, 1)',
                                'rgba(234, 88, 12, 1)'
                            ],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Production Impact Comparison'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Daily Production (MT)'
                            }
                        }
                    }
                }
            });
            
            setTimeout(() => {
                addSystemMessage('I have analyzed multiple response options. Would you like to see the recommended scenarios? (Just say "yes", "show scenarios", or "recommendations")');
            }, 2000);
        }

        // Track what has been shown to user
        let shownSections = {
            scenarioA: false,
            methodology: false,
            validation: false,
            equipment: false,
            scenarioB: false,
            scenarioC: false,
            explainability: false
        };

        function showScenarios() {
            addSystemMessage('Analyzing optimization scenarios based on current constraints...');
            updateVizTitle(`Optimization Scenarios - ${scenarioData[currentScenarioType].name}`);
            
            // Show scenarios one by one - just the overview first
            setTimeout(() => {
                showScenarioAOverview();
            }, 1000);
        }

        // Store chart instances to preserve them
        let impactChartInstance = null;

        function showScenarioAOverview() {
            const scenario = scenarioData[currentScenarioType].scenarios[0];
            const details = scenario.details;
            const costSign = scenario.costImpact < 0 ? '-' : '+';
            const costValue = Math.abs(scenario.costImpact);
            
            shownSections.scenarioA = true;
            
            const vizContent = document.getElementById('vizContent');
            const content = `
                <div class="scenario-card recommended" id="scenarioA">
                    <div class="scenario-header">
                        <div class="scenario-title">üìà Scenario A: ${scenario.title}</div>
                        <span class="scenario-badge badge-recommended">‚úì RECOMMENDED</span>
                    </div>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        ${scenario.description}
                    </p>
                    <div class="scenario-metrics">
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Cost Impact</div>
                            <div class="scenario-metric-value ${scenario.costImpact < 0 ? 'value-positive' : 'value-negative'}">${costSign}$${costValue.toLocaleString()}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Timeline</div>
                            <div class="scenario-metric-value value-positive">${scenario.timeline}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Risk Level</div>
                            <div class="scenario-metric-value value-positive">${scenario.riskLevel}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                        <strong>Financial Analysis:</strong><br>
                        ${Object.entries(details).filter(([key, value]) => key !== 'netSavings' && key !== 'netCost' && key !== 'customerRisk' && key !== 'qualityRisk').map(([key, value]) => `‚Ä¢ ${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${value < 0 ? '-' : '+'}$${Math.abs(value).toLocaleString()}`).join('<br>')}<br>
                        ‚Ä¢ <strong>Net ${scenario.costImpact < 0 ? 'Savings' : 'Cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}</strong>
                    </div>
                </div>
            `;
            
            // Check if scenarioA already exists to avoid duplicates
            const existingScenarioA = document.getElementById('scenarioA');
            if (!existingScenarioA) {
                // Create a wrapper div and append to it, preserving existing content
                const wrapper = document.createElement('div');
                wrapper.innerHTML = content;
                vizContent.appendChild(wrapper.firstElementChild);
            }
            
            setTimeout(() => {
                addSystemMessage(`Scenario A: ${scenario.title}. Net ${scenario.costImpact < 0 ? 'savings' : 'cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}. Timeline: ${scenario.timeline}.`);
                setTimeout(() => {
                    addSystemMessage('I can provide more details about this recommendation. Would you like to know how I estimated the downtime, see equipment criticality analysis, update the estimate, or compare with other scenarios?');
                }, 1500);
            }, 1500);
        }

        function showScenarioAMethodology() {
            if (shownSections.methodology) return; // Already shown
            
            shownSections.methodology = true;
            const vizContent = document.getElementById('vizContent');
            const existingMethodology = document.getElementById('methodologySection');
            
            if (existingMethodology) return; // Already exists
            
            const content = `
                <!-- Downtime Estimation Methodology -->
                <div class="estimation-methodology" id="methodologySection">
                    <div class="method-header">
                        <h4>üîç How We Estimated This Downtime</h4>
                        <span class="confidence-badge">Confidence: 75%</span>
                    </div>
                    
                    <div class="method-content">
                        <div class="method-section">
                            <div class="method-icon">üìä</div>
                            <div class="method-details">
                                <div class="method-title">Historical Data Analysis</div>
                                <div class="method-text">
                                    Based on <strong>12 similar bearing failures</strong> in MV-6 mixers over the past 3 years
                                    <ul>
                                        <li>Average downtime: 4.2 days</li>
                                        <li>Range: 3-7 days</li>
                                        <li>Most recent incident (Aug 2024): 4 days</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="method-section">
                            <div class="method-icon">‚öôÔ∏è</div>
                            <div class="method-details">
                                <div class="method-title">Equipment Criticality Score</div>
                                <div class="method-text">
                                    <strong>MV-6 Criticality: 8.5/10 (CRITICAL)</strong>
                                    <ul>
                                        <li>üî¥ Production stops completely if this equipment fails</li>
                                        <li>No redundancy: Single point of failure</li>
                                        <li>Affects: 100% of methionine production capacity</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="method-section">
                            <div class="method-icon">üîß</div>
                            <div class="method-details">
                                <div class="method-title">Maintenance Factors</div>
                                <div class="method-text">
                                    <ul>
                                        <li>‚úÖ Spare parts: In stock (bearing assemblies available)</li>
                                        <li>‚úÖ Maintenance team: Available immediately (no leave scheduled)</li>
                                        <li>‚ö†Ô∏è Specialized technician: 1-day lead time (external contractor)</li>
                                        <li>‚úÖ Historical repair time for this component: 3-4 days</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="method-section">
                            <div class="method-icon">üé≤</div>
                            <div class="method-details">
                                <div class="method-title">Uncertainty Factors</div>
                                <div class="method-text">
                                    <ul>
                                        <li>Extent of secondary damage: Unknown until inspection</li>
                                        <li>Potential shaft alignment issues: +1-2 days if detected</li>
                                        <li>Parts delivery contingency: Local supplier backup available</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="estimation-result">
                        <div class="result-box">
                            <div class="result-label">Estimated Downtime</div>
                            <div class="result-value" id="estimatedDowntime">3-5 days</div>
                            <div class="result-subtext">Most likely: 4 days</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Confidence Level</div>
                            <div class="result-value" style="color: var(--warning-orange);">75%</div>
                            <div class="result-subtext">Based on 12 historical incidents</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to existing content without replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            addSystemMessage('Here\'s how I estimated the downtime. I analyzed 12 similar historical incidents, equipment criticality scores, maintenance team availability, and spare parts inventory to arrive at 3-5 days with 75% confidence.');
        }

        function showValidationForm() {
            if (shownSections.validation) return;
            
            shownSections.validation = true;
            const vizContent = document.getElementById('vizContent');
            const existingValidation = document.getElementById('validationSection');
            
            if (existingValidation) return; // Already exists
            
            const content = `
                <!-- User Validation & Feedback -->
                <div class="user-validation-panel" id="validationSection">
                    <div class="validation-header">
                        <h4>‚úèÔ∏è Update Estimate Based on Actual Findings</h4>
                        <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                            Your input helps improve future predictions. Update the estimate as your team inspects the equipment.
                        </p>
                    </div>

                    <div class="validation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="actualDowntime">Actual/Revised Downtime Estimate (days)</label>
                                <input 
                                    type="number" 
                                    id="actualDowntime" 
                                    placeholder="e.g., 4" 
                                    min="0.5" 
                                    max="30" 
                                    step="0.5"
                                    class="form-input"
                                />
                            </div>

                            <div class="form-group">
                                <label for="downtimeReason">Reason for Adjustment (optional)</label>
                                <select id="downtimeReason" class="form-input">
                                    <option value="">-- Select reason --</option>
                                    <option value="more_damage">More extensive damage than expected</option>
                                    <option value="less_damage">Less damage than expected</option>
                                    <option value="parts_delay">Parts delivery delay</option>
                                    <option value="parts_available">Parts already available</option>
                                    <option value="specialist_unavailable">Specialist not available</option>
                                    <option value="specialist_available">Specialist available sooner</option>
                                    <option value="other">Other (specify in notes)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="validationNotes">Additional Notes (optional)</label>
                            <textarea 
                                id="validationNotes" 
                                rows="3" 
                                placeholder="e.g., 'Bearing damage extended to shaft. Need full replacement...'" 
                                class="form-input"
                            ></textarea>
                        </div>

                        <div class="form-actions">
                            <button id="updateEstimateBtn" class="btn-primary" onclick="updateDowntimeEstimate()">
                                Update Estimate & Recalculate Scenarios
                            </button>
                            <button class="btn-secondary" onclick="clearValidationForm()">
                                Clear
                            </button>
                        </div>

                        <div id="validationFeedback" class="validation-feedback" style="display: none;">
                            ‚úÖ Thank you! Estimate updated. This data will improve future predictions.
                        </div>
                    </div>

                    <div class="validation-impact">
                        <p><strong>üìà Learning Impact:</strong> Your corrections help the AI learn:</p>
                        <ul>
                            <li>Equipment-specific failure patterns</li>
                            <li>Actual vs. predicted repair times</li>
                            <li>Common reasons for estimate variations</li>
                            <li>Site-specific maintenance capabilities</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Append to existing content without replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            addSystemMessage('You can update the downtime estimate here. As your team inspects the equipment, input the actual findings and I\'ll recalculate all scenarios accordingly.');
        }

        function showEquipmentStatus() {
            if (shownSections.equipment) return;
            
            shownSections.equipment = true;
            const vizContent = document.getElementById('vizContent');
            const existingEquipment = document.getElementById('equipmentSection');
            
            if (existingEquipment) return; // Already exists
            
            const content = `
                <!-- Equipment Status with Criticality -->
                <div class="equipment-status-section" id="equipmentSection">
                    <h3>Equipment Status & Criticality</h3>
                    
                    <div class="equipment-list">
                        <div class="equipment-item critical">
                            <div class="equipment-criticality">
                                <span class="criticality-badge critical">üî¥ CRITICAL</span>
                                <span class="criticality-score">9.5/10</span>
                            </div>
                            <div class="equipment-name">MV-6 Mixer (FAILED)</div>
                            <div class="equipment-impact">
                                Impact if down: <strong>100% production loss</strong> | No redundancy
                            </div>
                        </div>

                        <div class="equipment-item important">
                            <div class="equipment-criticality">
                                <span class="criticality-badge important">üü° IMPORTANT</span>
                                <span class="criticality-score">7.2/10</span>
                            </div>
                            <div class="equipment-name">HE-3 Heat Exchanger</div>
                            <div class="equipment-impact">
                                Impact if down: <strong>40% capacity reduction</strong> | Partial redundancy
                            </div>
                        </div>

                        <div class="equipment-item normal">
                            <div class="equipment-criticality">
                                <span class="criticality-badge normal">üü¢ NORMAL</span>
                                <span class="criticality-score">4.1/10</span>
                            </div>
                            <div class="equipment-name">P-12 Transfer Pump</div>
                            <div class="equipment-impact">
                                Impact if down: <strong>Minimal</strong> | Full redundancy available
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Append to existing content without replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            addSystemMessage('Here\'s the equipment criticality analysis. MV-6 is critical with 9.5/10 score - any failure causes 100% production loss. Other equipment has redundancy options.');
        }

        function showScenarioB() {
            if (shownSections.scenarioB) return;
            
            shownSections.scenarioB = true;
            const scenario = scenarioData[currentScenarioType].scenarios[1];
            const details = scenario.details;
            const costSign = scenario.costImpact < 0 ? '-' : '+';
            const costValue = Math.abs(scenario.costImpact);
            
            const vizContent = document.getElementById('vizContent');
            const content = `
                <div class="scenario-card" id="scenarioB">
                    <div class="scenario-header">
                        <div class="scenario-title">üåè Scenario B: ${scenario.title}</div>
                    </div>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        ${scenario.description}
                    </p>
                    <div class="scenario-metrics">
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Cost Impact</div>
                            <div class="scenario-metric-value ${scenario.costImpact < 0 ? 'value-positive' : 'value-negative'}">${costSign}$${costValue.toLocaleString()}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Timeline</div>
                            <div class="scenario-metric-value value-neutral">${scenario.timeline}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Risk Level</div>
                            <div class="scenario-metric-value value-neutral">${scenario.riskLevel}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                        <strong>Financial Analysis:</strong><br>
                        ${Object.entries(details).filter(([key, value]) => key !== 'netSavings' && key !== 'netCost' && key !== 'customerRisk' && key !== 'qualityRisk').map(([key, value]) => `‚Ä¢ ${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${value < 0 ? '-' : '+'}$${Math.abs(value).toLocaleString()}`).join('<br>')}<br>
                        ‚Ä¢ <strong>Net ${scenario.costImpact < 0 ? 'Savings' : 'Cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}</strong>
                    </div>
                </div>
            `;
            
            // Append to existing content without replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            addSystemMessage(`Scenario B: ${scenario.title}. Net ${scenario.costImpact < 0 ? 'savings' : 'cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}. Timeline: ${scenario.timeline}.`);
        }

        function showScenarioC() {
            if (shownSections.scenarioC) return;
            
            shownSections.scenarioC = true;
            const scenario = scenarioData[currentScenarioType].scenarios[2];
            const details = scenario.details;
            const costSign = scenario.costImpact < 0 ? '-' : '+';
            const costValue = Math.abs(scenario.costImpact);
            
            const vizContent = document.getElementById('vizContent');
            const content = `
                <div class="scenario-card" id="scenarioC">
                    <div class="scenario-header">
                        <div class="scenario-title">üì¶ Scenario C: ${scenario.title}</div>
                    </div>
                    <p style="margin: 1rem 0; line-height: 1.6;">
                        ${scenario.description}
                    </p>
                    <div class="scenario-metrics">
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Cost Impact</div>
                            <div class="scenario-metric-value ${scenario.costImpact < 0 ? 'value-positive' : 'value-negative'}">${costSign}$${costValue.toLocaleString()}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Timeline</div>
                            <div class="scenario-metric-value value-negative">${scenario.timeline}</div>
                        </div>
                        <div class="scenario-metric">
                            <div class="scenario-metric-label">Risk Level</div>
                            <div class="scenario-metric-value value-negative">${scenario.riskLevel}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                        <strong>Financial Analysis:</strong><br>
                        ${Object.entries(details).filter(([key, value]) => key !== 'netSavings' && key !== 'netCost' && key !== 'customerRisk' && key !== 'qualityRisk').map(([key, value]) => `‚Ä¢ ${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${value < 0 ? '-' : '+'}$${Math.abs(value).toLocaleString()}`).join('<br>')}<br>
                        ‚Ä¢ <strong>Net ${scenario.costImpact < 0 ? 'Savings' : 'Cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}</strong>
                        ${details.customerRisk ? '<br><span style="color: #DC2626;">‚ö†Ô∏è Requires customer approval & impacts relationships</span>' : ''}
                        ${details.qualityRisk ? '<br><span style="color: #DC2626;">‚ö†Ô∏è Quality risk with alternative feedstock</span>' : ''}
                    </div>
                </div>
            `;
            
            // Append to existing content without replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            addSystemMessage(`Scenario C: ${scenario.title}. Net ${scenario.costImpact < 0 ? 'savings' : 'cost'}: $${Math.abs(scenario.costImpact).toLocaleString()}. Timeline: ${scenario.timeline}. Note: ${scenario.riskLevel} risk level.`);
            
            setTimeout(() => {
                addSystemMessage('Would you like to understand why Scenario A is recommended, or do you need more details on any of these options?');
            }, 1500);
        }

        function showExplainability() {
            if (shownSections.explainability && document.getElementById('explainabilitySection')) {
                // Already shown, just scroll to it
                document.getElementById('explainabilitySection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }
            
            shownSections.explainability = true;
            addSystemMessage('Here is the detailed reasoning behind my recommendation for Scenario A:');
            updateVizTitle('AI Explainability - Why Scenario A?');
            
            const vizContent = document.getElementById('vizContent');
            const content = `
                <div id="explainabilitySection">
                <div class="explainability-panel">
                    <div class="explainability-title">üß† Decision Reasoning: Why Scenario A is Optimal</div>
                    <div class="explainability-reasons">
                        <div class="reason-item">
                            <div class="reason-icon">1</div>
                            <div class="reason-text">
                                <strong>Immediate Execution Capability:</strong> ME5 unit has available capacity headroom (currently at 85% utilization). 
                                No lead time required - can begin compensation immediately.
                            </div>
                        </div>
                        <div class="reason-item">
                            <div class="reason-icon">2</div>
                            <div class="reason-text">
                                <strong>Best Financial Outcome:</strong> Net savings of $25K vs $60K cost (Scenario B) or $30K savings with high risk (Scenario C). 
                                Clear economic advantage.
                            </div>
                        </div>
                        <div class="reason-item">
                            <div class="reason-icon">3</div>
                            <div class="reason-text">
                                <strong>Tank Buffer Provides Safety:</strong> Current inventory of 4,200 MT provides 6.8 days coverage during ME5 ramp-up period. 
                                No immediate customer impact risk.
                            </div>
                        </div>
                        <div class="reason-item">
                            <div class="reason-icon">4</div>
                            <div class="reason-text">
                                <strong>Low Operational Risk:</strong> ME5 operates within design parameters at 105% capacity. 
                                Historical data shows reliable performance at these levels.
                            </div>
                        </div>
                        <div class="reason-item">
                            <div class="reason-icon">5</div>
                            <div class="reason-text">
                                <strong>No External Dependencies:</strong> Unlike Scenario B (requires Malaysia coordination) or Scenario C (customer approvals), 
                                Scenario A can be executed with local team only.
                            </div>
                        </div>
                        <div class="reason-item">
                            <div class="reason-icon">6</div>
                            <div class="reason-text">
                                <strong>Maintains Customer Relationships:</strong> Zero customer impact means no relationship risk, 
                                unlike Scenario C which could strain customer trust.
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(to right, rgba(22, 163, 74, 0.1), white); border-left: 4px solid #16A34A; border-radius: 8px;">
                    <h4 style="color: #16A34A; margin-bottom: 1rem;">‚úì Recommended Next Steps</h4>
                    <ol style="line-height: 1.8; padding-left: 1.5rem;">
                        <li>Notify Plant Manager to increase ME5 to 105% capacity</li>
                        <li>Adjust raw material delivery schedule (+15% hydrogen)</li>
                        <li>Update IBP forecast to reflect ME6 downtime</li>
                        <li>Monitor ME5 performance metrics hourly during ramp-up</li>
                        <li>Prepare contingency (Scenario B) if ME6 downtime exceeds 5 days</li>
                    </ol>
                </div>
                <div class="chart-container" style="margin-top: 2rem;">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="ai-reasoning-panel">
                    <div class="reasoning-header">
                        <h4>üí° Why We Recommend Scenario A</h4>
                        <span class="confidence-badge">Recommendation Confidence: 92%</span>
                    </div>
                    <div class="reasoning-content">
                        <div class="reasoning-section primary">
                            <div class="reasoning-icon">üéØ</div>
                            <div class="reasoning-details">
                                <div class="reasoning-title">PRIMARY: Customer Impact (70% weight)</div>
                                <div class="reasoning-score">Score: 100/100</div>
                                <div class="reasoning-explanation">
                                    ‚úÖ <strong>ZERO customer delay</strong> - This is our #1 priority<br>
                                    ‚úÖ All confirmed orders (3,550 MT) will ship on time<br>
                                    ‚úÖ PT Indonesia Feed (high-priority customer) not affected<br>
                                    ‚úÖ Customer retention risk: <span style="color: var(--success-green);">MINIMAL</span>
                                </div>
                            </div>
                        </div>
                        <div class="reasoning-section secondary">
                            <div class="reasoning-icon">üí∞</div>
                            <div class="reasoning-details">
                                <div class="reasoning-title">SECONDARY: Cost Efficiency (25% weight)</div>
                                <div class="reasoning-score">Score: 65/100</div>
                                <div class="reasoning-explanation">
                                    ‚ö†Ô∏è Higher cost ($45K vs $30K baseline)<br>
                                    ‚ûï Additional $15K justified by customer retention<br>
                                    ‚ûï Avoids potential revenue loss from delayed shipments ($85K risk)<br>
                                    ‚ûï <strong>Net benefit: $40K</strong> (avoided losses - additional costs)
                                </div>
                            </div>
                        </div>
                        <div class="reasoning-section tertiary">
                            <div class="reasoning-icon">‚ö°</div>
                            <div class="reasoning-details">
                                <div class="reasoning-title">TERTIARY: Speed of Resolution (5% weight)</div>
                                <div class="reasoning-score">Score: 95/100</div>
                                <div class="reasoning-explanation">
                                    ‚úÖ Immediate action (within 4 hours)<br>
                                    ‚úÖ Antwerp plant can ramp up same day<br>
                                    ‚úÖ Logistics already coordinated with Katoen Natie
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="reasoning-comparison">
                        <h5>üìä Why Not Scenario B or C?</h5>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Factor</th>
                                    <th>Scenario A ‚úÖ</th>
                                    <th>Scenario B</th>
                                    <th>Scenario C</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Customer Delay</strong></td>
                                    <td style="color: var(--success-green);"><strong>0 days</strong></td>
                                    <td style="color: var(--warning-orange);">2 days</td>
                                    <td style="color: var(--alert-red);">4 days</td>
                                </tr>
                                <tr>
                                    <td><strong>Cost</strong></td>
                                    <td>$45K</td>
                                    <td style="color: var(--success-green);"><strong>$30K</strong></td>
                                    <td style="color: var(--success-green);">$15K</td>
                                </tr>
                                <tr>
                                    <td><strong>Customer Satisfaction</strong></td>
                                    <td style="color: var(--success-green);"><strong>HIGH</strong></td>
                                    <td style="color: var(--warning-orange);">MEDIUM</td>
                                    <td style="color: var(--alert-red);">LOW</td>
                                </tr>
                                <tr>
                                    <td><strong>Revenue Risk</strong></td>
                                    <td style="color: var(--success-green);"><strong>$0</strong></td>
                                    <td style="color: var(--warning-orange);">$35K</td>
                                    <td style="color: var(--alert-red);">$85K</td>
                                </tr>
                                <tr class="total-row">
                                    <td><strong>TOTAL SCORE</strong></td>
                                    <td style="color: var(--success-green); font-size: 1.1rem;"><strong>92/100</strong></td>
                                    <td>74/100</td>
                                    <td>56/100</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="reasoning-footer">
                        <p><strong>Bottom Line:</strong> While Scenario A costs $15K-$30K more, it protects our customer relationships 
                        (our #1 value) and avoids potential revenue loss of $85K. The additional cost is a <strong>strategic investment 
                        in customer retention</strong>, which aligns with Evonik's customer-intimacy focus.</p>
                    </div>
                </div>

                <!-- Calculation Summary -->
                <div class="explainability-section">
                    <h4>üîç How was this calculated?</h4>
                    <div class="decision-tree">
                        <div class="step">1. Analyzed historical data: 12 similar incidents over past 3 years</div>
                        <div class="step">2. Evaluated current constraints: ME5 capacity, tank inventory, customer commitments</div>
                        <div class="step">3. Weighted factors: Customer impact (70%), Cost efficiency (25%), Speed (5%)</div>
                        <div class="step">4. Confidence level: 92% based on data quality and scenario alignment</div>
                    </div>
                </div>
                </div>
            `;
            
            // Append explainability section instead of replacing
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;
            vizContent.appendChild(wrapper.firstElementChild);
            
            // Create comparison chart after content is appended
            setTimeout(() => {
                const chartCanvas = document.getElementById('comparisonChart');
                if (chartCanvas) {
                    const ctx = chartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['Cost Efficiency', 'Speed', 'Risk Level', 'Customer Impact', 'Operational Ease', 'Success Probability'],
                            datasets: [
                                {
                                    label: 'Scenario A',
                                    data: [95, 100, 90, 100, 95, 95],
                                    borderColor: 'rgba(22, 163, 74, 1)',
                                    backgroundColor: 'rgba(22, 163, 74, 0.2)',
                                    borderWidth: 2
                                },
                                {
                                    label: 'Scenario B',
                                    data: [60, 70, 75, 85, 60, 80],
                                    borderColor: 'rgba(234, 88, 12, 1)',
                                    backgroundColor: 'rgba(234, 88, 12, 0.2)',
                                    borderWidth: 2
                                },
                                {
                                    label: 'Scenario C',
                                    data: [70, 60, 40, 30, 80, 65],
                                    borderColor: 'rgba(220, 38, 38, 1)',
                                    backgroundColor: 'rgba(220, 38, 38, 0.2)',
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Multi-Factor Scenario Comparison (0-100 scale)'
                                }
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        function switchRole() {
            const selector = document.getElementById('roleSelector');
            currentRole = selector.value;
            
            // Clear chat and restart
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('vizContent').innerHTML = `
                <div class="viz-placeholder">
                    <div class="viz-placeholder-icon">üìä</div>
                    <h3>Ask me a question to get started</h3>
                    <p>I can show you production metrics, tank levels, cost analysis, and optimization scenarios</p>
                </div>
            `;
            
            messageCount = 0;
            crisisTriggered = false;
            conversationState = 'initial';
            document.getElementById('quickActions').style.display = 'flex';
            
            initChat();
        }

        function switchScenario() {
            const selector = document.getElementById('scenarioSelector');
            currentScenarioType = selector.value;
            
            // If crisis is already triggered, update the display
            if (crisisTriggered) {
                showCrisisImpact();
            }
        }

        function updateVizTitle(title) {
            document.getElementById('vizTitle').textContent = title;
            const now = new Date();
            document.getElementById('vizTimestamp').textContent = `Updated: ${now.toLocaleTimeString()}`;
        }

        // Update downtime estimate based on user input
        function updateDowntimeEstimate() {
            const actualDowntime = document.getElementById('actualDowntime').value;
            const reason = document.getElementById('downtimeReason').value;
            const notes = document.getElementById('validationNotes').value;
            
            if (!actualDowntime) {
                alert('Please enter an actual downtime estimate');
                return;
            }
            
            // Update the displayed estimate
            const estEl = document.getElementById('estimatedDowntime');
            if (estEl) {
                estEl.textContent = actualDowntime + ' days';
            }
            
            // Show feedback
            const feedback = document.getElementById('validationFeedback');
            if (feedback) {
                feedback.style.display = 'block';
                feedback.innerHTML = `‚úÖ Estimate updated to ${actualDowntime} days. Recalculating scenarios...`;
            }
            
            // Simulate recalculation
            setTimeout(() => {
                if (feedback) {
                    feedback.innerHTML = '‚úÖ Thank you! Scenarios updated. This data will improve future predictions.';
                }
                console.log('User validation logged:', {
                    originalEstimate: '3-5 days',
                    revisedEstimate: actualDowntime + ' days',
                    reason: reason,
                    notes: notes,
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }

        function clearValidationForm() {
            const d = document.getElementById('actualDowntime');
            const r = document.getElementById('downtimeReason');
            const n = document.getElementById('validationNotes');
            if (d) d.value = '';
            if (r) r.value = '';
            if (n) n.value = '';
            const feedback = document.getElementById('validationFeedback');
            if (feedback) feedback.style.display = 'none';
        }

        // Check for crisis parameter in URL
        function checkForCrisisParameter() {
            const urlParams = new URLSearchParams(window.location.search);
            const crisisType = urlParams.get('crisis');
            if (crisisType && (crisisType === 'equipment_failure' || crisisType === 'supply_delay')) {
                // Clear the URL parameter to prevent re-triggering on refresh
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                
                // Set scenario type before triggering
                currentScenarioType = crisisType;
                document.getElementById('scenarioSelector').value = crisisType;
                
                // Trigger crisis immediately with the specific type
                setTimeout(() => {
                    triggerCrisis(crisisType);
                }, 1000);
                return true;
            }
            return false;
        }

        // Demo trigger detection
        function checkForDemoTrigger() {
            const event = safeParseLocalStorage(CONSTANTS.COORDINATION_EVENT_KEY);
            if (event) {
                if (event.demo_trigger && (event.type === 'equipment_failure' || event.type === 'supply_delay')) {
                    // Clear the event to prevent re-triggering
                    localStorage.removeItem(CONSTANTS.COORDINATION_EVENT_KEY);
                    
                    // Set scenario type before triggering
                    currentScenarioType = event.type;
                    document.getElementById('scenarioSelector').value = event.type;
                    
                    // Trigger crisis with specific scenario type
                    setTimeout(() => {
                        triggerCrisis(event.type);
                    }, 1000);
                    return true;
                }
            }
            return false;
        }

        // Check for demo triggers every 500ms (only if not already triggered)
        setInterval(() => {
            if (!crisisAlreadyTriggered) {
                const triggered = checkForDemoTrigger();
                if (triggered) {
                    crisisAlreadyTriggered = true;
                }
            }
        }, 500);


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for crisis parameter first (from URL link click)
            const urlTriggered = checkForCrisisParameter();
            
            // If URL didn't trigger, check for localStorage event (from other pages)
            if (!urlTriggered) {
                // Check once immediately
                const storageTriggered = checkForDemoTrigger();
                
                // Only initialize chat if neither triggered a crisis
                if (!storageTriggered) {
                    initChat();
                }
            }
        });
    </script>
</body>
</html>