<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="https://onsenix12.github.io/evonik-dashboard/">
    <title>Evonik Production Coordination Hub</title>
    <link rel="stylesheet" href="shared-styles-new.css">
    <style>
        /* Page-specific styles */
        .header {
            background: linear-gradient(135deg, var(--evonik-purple) 0%, var(--evonik-dark-purple) 100%);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: var(--success-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Floating Demo Controls */
        .demo-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .demo-fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--evonik-purple), var(--evonik-light-purple));
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 46, 139, 0.4);
            transition: all 0.3s ease;
        }

        .demo-fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(139, 46, 139, 0.6);
        }

        .demo-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 1rem;
            min-width: 280px;
            display: none;
        }

        .demo-menu.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .demo-menu-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .demo-menu-item {
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-gray);
            font-size: 0.9rem;
        }

        .demo-menu-item:hover {
            background: var(--evonik-purple);
            color: white;
            transform: translateX(4px);
        }

        .regional-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .region-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .region-card.operational {
            border-left-color: var(--success-green);
            background: rgba(22, 163, 74, 0.02);
        }

        .region-card.warning {
            border-left-color: var(--warning-orange);
            background: rgba(234, 88, 12, 0.02);
        }

        .region-name {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .region-metrics {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .region-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .inventory-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .inventory-location {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .inventory-level {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--evonik-purple);
            margin-bottom: 0.75rem;
        }

        .inventory-level.warning {
            color: var(--warning-orange);
        }

        .inventory-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .inventory-status.adequate {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success-green);
        }

        .inventory-status.low {
            background: rgba(234, 88, 12, 0.1);
            color: var(--warning-orange);
        }

        .event-timeline {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .timeline-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }

        .timeline-list {
            list-style: none;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-left: 2px solid var(--border-gray);
            padding-left: 1.5rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 1.25rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--evonik-purple);
        }

        .timeline-time {
            font-weight: 600;
            color: var(--text-light);
            min-width: 70px;
            font-size: 0.9rem;
        }

        .timeline-content {
            flex: 1;
            color: var(--text-dark);
        }

        .timeline-icon {
            margin-right: 0.5rem;
        }

        .events-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .events-list {
            list-style: none;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-gray);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .event-date {
            font-weight: 700;
            color: var(--evonik-purple);
            min-width: 70px;
            text-align: center;
            font-size: 0.95rem;
        }

        .event-content {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .event-detail {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .alert-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-gray);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .alert-header {
            background: linear-gradient(135deg, var(--warning-orange), #F97316);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .alert-count {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .alert-list {
            list-style: none;
            padding: 0;
        }

        .alert-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: start;
            gap: 1rem;
            transition: background 0.2s;
        }

        .alert-item:hover {
            background: var(--bg-gray);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .alert-detail {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .total-metric {
            text-align: center;
            padding-top: 1rem;
            border-top: 2px solid var(--border-gray);
            margin-top: 1rem;
        }

        .total-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .total-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--evonik-purple);
        }

        #plantWorldMap { 
            height: 600px; 
            border-radius: 12px; 
            border: 1px solid var(--border-gray); 
            overflow: hidden;
            margin-bottom: 2rem;
            position: relative;
        }

        .leaflet-interactive { 
            cursor: pointer; 
        }

        /* Flow Lines Animation - Real-time shipment visualization */
        @keyframes flowAnimation {
            0% {
                stroke-dashoffset: 100;
                opacity: 0.4;
            }
            50% {
                opacity: 1;
            }
            100% {
                stroke-dashoffset: 0;
                opacity: 0.4;
            }
        }

        .flow-line {
            fill: none;
            stroke-dasharray: 15 10;
            animation: flowAnimation 4s linear infinite;
            cursor: pointer;
        }

        .flow-line.high-volume {
            stroke-width: 6;
        }

        .flow-line.medium-volume {
            stroke-width: 4;
        }

        .flow-line.low-volume {
            stroke-width: 2;
        }

        /* Flow label styling */
        .flow-label-badge {
            background: rgba(139, 46, 139, 0.95);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
            border: 2px solid white;
        }

        /* Plant markers - simple */
        .plant-marker {
            fill: var(--evonik-purple);
            stroke: white;
            stroke-width: 3;
        }

        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 220px;
            font-size: 0.85rem;
        }

        .map-legend-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-gray);
            padding-bottom: 0.5rem;
        }

        .map-legend-section {
            margin-bottom: 0.75rem;
        }

        .map-legend-section:last-child {
            margin-bottom: 0;
        }

        .map-legend-section-title {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .map-legend-item:last-child {
            margin-bottom: 0;
        }

        .map-legend-line {
            width: 40px;
            height: 0;
            border: none;
            border-top: 3px solid;
            flex-shrink: 0;
        }

        .map-legend-line.high {
            border-top-width: 6px;
            border-top-color: #8B2E8B;
        }

        .map-legend-line.medium {
            border-top-width: 4px;
            border-top-color: #A855F7;
        }

        .map-legend-line.low {
            border-top-width: 2px;
            border-top-color: #C084FC;
        }

        .map-legend-label {
            color: var(--text-dark);
            font-size: 0.8rem;
        }

        .map-legend-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .map-legend-status.in-transit {
            background: rgba(139, 46, 139, 0.1);
            color: #8B2E8B;
        }

        .map-legend-status.scheduled {
            background: rgba(168, 85, 247, 0.1);
            color: #A855F7;
        }

        /* Strategic Metrics - Comparison Styles */
        .metric-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            padding: 0.75rem;
            background: var(--bg-gray);
            border-radius: 8px;
        }

        .comparison-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comparison-label {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .comparison-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .metric-variance {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .metric-variance.positive {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success-green);
        }

        .metric-variance.negative {
            background: rgba(234, 88, 12, 0.1);
            color: var(--warning-orange);
        }

        .metric-action {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(139, 46, 139, 0.05);
            border-left: 3px solid var(--evonik-purple);
            border-radius: 4px;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-dark);
            text-align: left;
        }

        .metric-action strong {
            color: var(--evonik-purple);
            display: block;
            margin-bottom: 0.25rem;
        }

        /* Fixed Alert Banner Styles */
        .alerts-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: var(--alert-red);
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            animation: slideDown 0.5s ease;
        }

        .alerts-banner.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
            font-weight: 300;
        }

        .alert-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Alert overlays nav due to higher z-index (2000 vs 100) */
        /* Nav remains functional underneath the fixed alert banner */
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">üß™ Evonik</div>
                <div>
                    <div style="font-size: 1.2rem; font-weight: 600;">Production Coordination Hub</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Jurong Island Methionine Complex - Singapore</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="userDisplay">Live System</span>
            </div>
        </div>
    </header>

    <nav class="stakeholder-nav">
        <div class="nav-content">
            <div class="stakeholder-btn active">
                üéØ Coordination Hub
            </div>
            <a href="optimizer-new.html" class="stakeholder-btn optimizer">
                ü§ñ AI Decision Optimizer
            </a>
            <a href="sales-new.html" class="stakeholder-btn">
                üìà Sales
            </a>
            <a href="global-supply-chain-new.html" class="stakeholder-btn">
                üåè Global SC
            </a>
            <a href="local-supply-chain-new.html" class="stakeholder-btn">
                üìä Local SC
            </a>
            <a href="production-new.html" class="stakeholder-btn">
                üè≠ Production
            </a>
        </div>
    </nav>

    <div class="alerts-banner" id="alertsBanner">
        <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <strong>üö® ALERT:</strong> <span id="alertMessage"></span>
            </div>
            <button class="alert-close-btn" id="alertCloseBtn" onclick="closeAlert()" aria-label="Close alert">√ó</button>
        </div>
    </div>

    <main class="main-content">
        <!-- Strategic Metrics Dashboard -->
        <div class="section-header">
            <h2 class="section-title">üéØ Strategic Metrics Dashboard</h2>
            <div style="color: var(--text-light); font-size: 0.9rem;">
                Performance vs. targets ‚Ä¢ Decision-making indicators ‚Ä¢ Last updated: <span id="lastUpdate">Just now</span>
            </div>
        </div>

        <div class="strategic-metrics">
            <div class="metric-card highlighted">
                <h4>Contribution Margin</h4>
                <div class="value">$12.4M</div>
                <div class="subtext" style="margin-bottom: 0.75rem;">Monthly ‚Ä¢ End-to-end: Sales - RM - Production</div>
                <div class="metric-comparison">
                    <div class="comparison-item">
                        <span class="comparison-label">Monthly Target:</span>
                        <span class="comparison-value">$13.0M</span>
                    </div>
                    <div class="comparison-item">
                        <span class="comparison-label">Status:</span>
                        <span class="status-badge status-warning" id="marginStatus">Below Target</span>
                    </div>
                </div>
                <div class="metric-variance negative" id="marginVariance">-4.6% vs monthly target</div>
                <div class="metric-action">
                    <strong>Decision Focus:</strong> Review production efficiency and raw material costs. Production should optimize unit operations; Sales should prioritize higher-margin orders; Supply Chain should evaluate RM sourcing strategies.
                </div>
            </div>
            <div class="metric-card">
                <h4>Customer Intimacy Score</h4>
                <div class="value">94%</div>
                <div class="subtext" style="margin-bottom: 0.75rem;">Monthly ‚Ä¢ On-time delivery + quality</div>
                <div class="metric-comparison">
                    <div class="comparison-item">
                        <span class="comparison-label">Monthly Target:</span>
                        <span class="comparison-value">95%</span>
                    </div>
                    <div class="comparison-item">
                        <span class="comparison-label">Status:</span>
                        <span class="status-badge status-warning" id="intimacyStatus">Slightly Below</span>
                    </div>
                </div>
                <div class="metric-variance negative" id="intimacyVariance">-1.0% vs monthly target</div>
                <div class="metric-action">
                    <strong>Decision Focus:</strong> Monitor delivery schedules and quality metrics. Supply Chain should prioritize on-time shipments; Production should maintain quality standards; Sales should proactively communicate any delays.
                </div>
            </div>
        </div>

        <!-- 2-Week Forecast Visibility -->
        <div class="section-panel">
            <h3 class="section-title">üìÖ 2-Week Forecast Visibility</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
                Forward-looking visibility for plant shutdowns and maintenance planning
            </p>
            
            <div class="forecast-grid">
                <div class="forecast-week">
                    <h4>Week 1 (Oct 28 - Nov 3)</h4>
                    <div class="forecast-details">
                        <div class="forecast-metric">
                            <div class="forecast-label">Production Capacity</div>
                            <div class="forecast-value">965 MT/day</div>
                            <div class="forecast-subtext">Full capacity expected</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="forecast-label">Maintenance Windows</div>
                            <div class="forecast-value">None scheduled</div>
                            <div class="forecast-subtext">All units operational</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="forecast-label">Incoming Shipments</div>
                            <div class="forecast-value">3 shipments</div>
                            <div class="forecast-subtext">Raw materials: 2,400 MT</div>
                        </div>
                    </div>
                </div>
                
                <div class="forecast-week">
                    <h4>Week 2 (Nov 4 - Nov 10)</h4>
                    <div class="forecast-details">
                        <div class="forecast-metric">
                            <div class="forecast-label">Production Capacity</div>
                            <div class="forecast-value">620 MT/day</div>
                            <div class="forecast-subtext">ME6 maintenance scheduled</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="forecast-label">Maintenance Windows</div>
                            <div class="forecast-value">ME6 - 40hr cycle</div>
                            <div class="forecast-subtext">Nov 5-7: 3-day shutdown</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="forecast-label">Incoming Shipments</div>
                            <div class="forecast-value">2 shipments</div>
                            <div class="forecast-subtext">Adjusted for maintenance</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Status Overview -->
        <div class="section-header">
            <h2 class="section-title">Mission Control - System Status</h2>
            <div style="color: var(--text-light); font-size: 0.9rem;">
                Cross-functional coordination overview ‚Ä¢ Last updated: <span id="lastUpdate">Just now</span>
            </div>
        </div>

        <!-- System Health Dashboard -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üö¶ System Health</div>
                    <div class="card-status status-operational" id="overallStatus">Operational</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Production</div>
                    <div class="metric-value" id="productionStatusText">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Inventory</div>
                    <div class="metric-value" id="inventoryStatusText">
                        <span class="status-indicator warning">
                            <span class="status-dot"></span>
                            <span>Action Needed</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Shipping</div>
                    <div class="metric-value">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span id="shippingStatusText">On Schedule</span>
                        </span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">Orders</div>
                    <div class="metric-value">
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span id="ordersStatusText">Confirmed</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <div class="card-header">
                    <div class="card-title">Plant Operations</div>
                    <div class="card-status status-operational" id="plantStatus">Operational</div>
                </div>
                <div style="position: relative; height: 280px; padding: 1rem;">
                    <canvas id="plantOperationsChart"></canvas>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 0 1rem 1rem 1rem; border-top: 1px solid var(--border-gray); margin-top: 0.5rem; padding-top: 1rem;">
                    <div class="metric">
                        <div class="metric-label">ME5 Unit</div>
                        <div class="metric-value" id="me5Output">620 MT/day</div>
                        <div class="metric-subtext" id="me5Status">Online</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">ME6 Unit</div>
                        <div class="metric-value" id="me6Output">345 MT/day</div>
                        <div class="metric-subtext" id="me6Status">Online</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Output</div>
                        <div class="metric-value" id="totalOutput">965 MT/day</div>
                        <div class="metric-subtext">Target: 965 MT/day</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Impact Analysis Module - Only show when there's an active shutdown -->
        <div class="impact-analysis" id="shutdownImpact" style="display: none;">
            <h4>‚ö†Ô∏è Unplanned Shutdown Impact</h4>
            <div class="impact-grid">
                <div>üì¶ Raw Materials: <span id="impactRawMaterials">3 shipments affected</span></div>
                <div>üìä Inventory: <span id="impactInventory">-2,400 MT shortfall</span></div>
                <div>üë• Customers: <span id="impactCustomers">5 orders delayed</span></div>
                <div>üí∞ Cost: <span id="impactCost">$45K demurrage risk</span></div>
            </div>
        </div>

        <!-- Critical Alerts -->
        <div class="alert-card">
            <div class="alert-header">
                <h3>üîî Critical Alerts</h3>
                <span class="alert-count" id="alertCount">2 Active</span>
            </div>
            <ul class="alert-list" id="alertsList">
                <li class="alert-item">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-content">
                        <div class="alert-title">ME6 Unit - Maintenance Required</div>
                        <div class="alert-detail">Scheduled maintenance window in 48 hours ‚Ä¢ Coordinate with production team</div>
                    </div>
                </li>
                <li class="alert-item">
                    <span class="alert-icon">üì¶</span>
                    <div class="alert-content">
                        <div class="alert-title">Singapore Inventory Below Safety Stock</div>
                        <div class="alert-detail">Current status requires attention ‚Ä¢ Review with supply chain team</div>
                    </div>
                </li>
            </ul>
        </div>

        <!-- Regional Fulfillment Status -->
        <h2 class="section-title">üåç Regional Fulfillment Status</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            High-level regional order status ‚Ä¢ For detailed customer information, see Sales Dashboard
        </p>
        
        <div class="regional-grid">
            <div class="region-card operational">
                <div class="region-name">APAC</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="apacOrders">8 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Adequate</span>
                    </div>
                </div>
            </div>

            <div class="region-card warning">
                <div class="region-name">Europe</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator warning">
                            <span class="status-dot"></span>
                            <span>Delayed</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="europeOrders">5 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Low</span>
                    </div>
                </div>
            </div>

            <div class="region-card operational">
                <div class="region-name">Americas</div>
                <div class="region-metrics">
                    <div class="region-metric">
                        <span class="metric-label">Status</span>
                        <span class="status-indicator operational">
                            <span class="status-dot"></span>
                            <span>On Track</span>
                        </span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Active Orders</span>
                        <span class="metric-value" id="americasOrders">12 orders</span>
                    </div>
                    <div class="region-metric">
                        <span class="metric-label">Inventory</span>
                        <span class="metric-value">Adequate</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finished Goods Inventory -->
        <h2 class="section-title">üì¶ Finished Goods Inventory</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            Regional inventory levels ‚Ä¢ For detailed inventory management, see Local Supply Chain Dashboard
        </p>

        <div class="inventory-grid">
            <div class="inventory-card">
                <div class="inventory-location">üáßüá™ Antwerp</div>
                <div class="inventory-level" id="antwerpInventory">2.8K MT</div>
                <div class="inventory-status adequate">
                    <span class="status-dot"></span>
                    <span>Adequate</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="inventory-location">üá∫üá∏ Mobile</div>
                <div class="inventory-level warning" id="mobileInventory">1.2K MT</div>
                <div class="inventory-status low">
                    <span class="status-dot"></span>
                    <span>Low Stock</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="inventory-location">üá∏üá¨ Singapore</div>
                <div class="inventory-level" id="singaporeInventory">3.4K MT</div>
                <div class="inventory-status adequate">
                    <span class="status-dot"></span>
                    <span>Adequate</span>
                </div>
            </div>

            <div class="inventory-card">
                <div class="total-metric">
                    <div class="total-label">Global Total</div>
                    <div class="total-value" id="globalInventory">7.4K MT</div>
                </div>
            </div>
        </div>

        <!-- Upcoming Events & Timeline -->
        <div class="dashboard-grid">
            <!-- Upcoming Events -->
            <div class="events-card">
                <div class="timeline-header">üìÖ Upcoming Events (Next 7 Days)</div>
                <ul class="events-list">
                    <li class="event-item">
                        <div class="event-date">Nov 2</div>
                        <div class="event-content">
                            <div class="event-title">ME5 Maintenance</div>
                            <div class="event-detail">24-hour cycle maintenance + 12hrs startup</div>
                        </div>
                    </li>
                    <li class="event-item">
                        <div class="event-date">Nov 5</div>
                        <div class="event-content">
                            <div class="event-title">Rotterdam Bulk Shipment</div>
                            <div class="event-detail">2,400 MT scheduled departure</div>
                        </div>
                    </li>
                    <li class="event-item">
                        <div class="event-date">Nov 7</div>
                        <div class="event-content">
                            <div class="event-title">Monthly Planning Meeting</div>
                            <div class="event-detail">Cross-functional coordination session</div>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- Coordination Timeline -->
            <div class="event-timeline" style="grid-column: span 2;">
                <div class="timeline-header">‚è±Ô∏è Coordination Timeline (Last 30 minutes)</div>
                <ul class="timeline-list" id="timelineList">
                    <li class="timeline-item">
                        <div class="timeline-time">14:15</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">‚öôÔ∏è</span>
                            <strong>Production:</strong> ME6 equipment issue detected
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:16</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üåè</span>
                            <strong>Global SC:</strong> Capacity rebalanced to Mobile plant
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:18</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üìä</span>
                            <strong>Sales:</strong> Customer deliveries adjusted
                        </div>
                    </li>
                    <li class="timeline-item">
                        <div class="timeline-time">14:25</div>
                        <div class="timeline-content">
                            <span class="timeline-icon">üì¶</span>
                            <strong>Local SC:</strong> Emergency raw material ordered
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Production Flow Map -->
        <h2 class="section-title">üó∫Ô∏è Production Flow Map</h2>
        <p style="color: var(--text-light); font-size: 0.9rem; margin: -0.5rem 0 1.5rem 0;">
            Real-time shipment flows from plants to regions ‚Ä¢ Volume allocation visualization
        </p>
        <div id="plantWorldMap" style="position: relative;">
            <!-- Map Legend -->
            <div class="map-legend">
                <div class="map-legend-title">üìä Flow Legend</div>
                
                <div class="map-legend-section">
                    <div class="map-legend-section-title">Volume (Line Thickness &amp; Color)</div>
                    <div class="map-legend-item">
                        <div class="map-legend-line high" style="border-top-color: #8B2E8B;"></div>
                        <div class="map-legend-label"><strong>High Volume</strong> (&gt;10K MT)<br/><span style="color: var(--text-light); font-size: 0.75rem;">Primary shipments</span></div>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-line medium" style="border-top-color: #A855F7;"></div>
                        <div class="map-legend-label"><strong>Medium Volume</strong> (2K-10K MT)<br/><span style="color: var(--text-light); font-size: 0.75rem;">Secondary routes</span></div>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-line low" style="border-top-color: #C084FC;"></div>
                        <div class="map-legend-label"><strong>Low Volume</strong> (&lt;2K MT)<br/><span style="color: var(--text-light); font-size: 0.75rem;">Backup/overflow</span></div>
                    </div>
                </div>
                
                <div class="map-legend-section">
                    <div class="map-legend-section-title">Status</div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div class="map-legend-status in-transit">
                            <span>üîÑ</span> In Transit
                        </div>
                        <div class="map-legend-status scheduled">
                            <span>üìÖ</span> Scheduled
                        </div>
                    </div>
                </div>
                
                <div class="map-legend-section">
                    <div class="map-legend-section-title">Symbols</div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: #8B2E8B; border: 2px solid white;"></div>
                        <div class="map-legend-label">Production Plant</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="padding: 0.25rem 0.5rem; background: rgba(139, 46, 139, 0.9); color: white; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">MT</div>
                        <div class="map-legend-label">Volume Badge</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Demo Controls -->
    <div class="demo-fab">
        <button class="demo-fab-button" id="demoFabBtn" onclick="toggleDemoMenu()">
            üéÆ
        </button>
        <div class="demo-menu" id="demoMenu">
            <div class="demo-menu-header">üéÆ Live Demo Controls</div>
            <div class="demo-menu-item" onclick="triggerEquipmentFailure()">
                ‚öôÔ∏è Equipment Failure
            </div>
            <div class="demo-menu-item" onclick="triggerBulkOrderSync()">
                üìä Bulk Order Sync
            </div>
            <div class="demo-menu-item" onclick="triggerSupplyChainAdjustment()">
                üîÑ SC Adjustment
            </div>
            <div class="demo-menu-item" onclick="triggerGlobalRebalancing()">
                üåè Global Rebalancing
            </div>
            <div class="demo-menu-item" onclick="resetDemo()" style="border-top: 1px solid var(--border-gray); margin-top: 0.5rem; padding-top: 0.75rem;">
                üîÑ Reset Demo
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Toggle demo menu
        function toggleDemoMenu() {
            const menu = document.getElementById('demoMenu');
            menu.classList.toggle('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const fab = document.querySelector('.demo-fab');
            const menu = document.getElementById('demoMenu');
            if (!fab.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 'Just now';
        }
        updateTime();
        setInterval(updateTime, 30000);

        // Demo scenario functions
        function triggerEquipmentFailure() {
            const event = {
                type: 'equipment_failure',
                data: { unit: 'ME6', impact: 'Production reduced to 70%' },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Show red alert banner
            showAlert('üö® CRITICAL: ME6 equipment failure detected - Production capacity reduced to 70%');
            
            // Update UI
            document.getElementById('plantStatus').textContent = 'Issue Detected';
            document.getElementById('plantStatus').className = 'card-status';
            document.getElementById('plantStatus').style.background = 'rgba(234, 88, 12, 0.1)';
            document.getElementById('plantStatus').style.color = 'var(--warning-orange)';
            
            // Update chart data
            updatePlantOperationsChart(620, 240, 860);
            
            document.getElementById('me6Output').textContent = '240 MT/day';
            document.getElementById('totalOutput').textContent = '860 MT/day';
            document.getElementById('me6Status').textContent = 'Reduced Capacity';
            document.getElementById('me6Status').style.color = 'var(--warning-orange)';
            
            // Show shutdown impact section
            document.getElementById('shutdownImpact').style.display = 'block';
            document.getElementById('impactRawMaterials').textContent = '3 shipments affected';
            document.getElementById('impactInventory').textContent = '-2,400 MT shortfall';
            document.getElementById('impactCustomers').textContent = '5 orders delayed';
            document.getElementById('impactCost').textContent = '$45K demurrage risk';
            
            addTimelineEvent('‚öôÔ∏è', 'Production', 'ME6 equipment failure - Auto-response initiated');
            addAlert('‚ö†Ô∏è', 'Equipment Failure Detected', 'ME6 unit operating at reduced capacity - Backup systems activated');
            
            toggleDemoMenu();
        }

        function triggerBulkOrderSync() {
            const event = {
                type: 'bulk_order_sync',
                data: { orders: 15, total_mt: 4200 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Show alert banner
            showAlert('üìä Bulk order sync: 15 new orders processed (4,200 MT total) - Review capacity planning');
            
            // Update UI
            const currentOrders = parseInt(document.getElementById('apacOrders').textContent);
            document.getElementById('apacOrders').textContent = (currentOrders + 15) + ' orders';
            addTimelineEvent('üìä', 'Sales', '15 bulk orders synced from SAP - 4,200 MT total');
            
            toggleDemoMenu();
        }

        function triggerSupplyChainAdjustment() {
            const event = {
                type: 'supply_chain_adjustment',
                data: { delay_days: 3, impact_mt: 850 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Show alert banner
            showAlert('üîÑ Supply chain adjustment: Shipment delayed 3 days - 850 MT impact - Alternative routing activated');
            
            // Update UI
            document.getElementById('shippingStatusText').textContent = 'Adjusted';
            addTimelineEvent('üîÑ', 'Supply Chain', 'Shipment schedule adjusted - 3 day delay mitigated');
            
            toggleDemoMenu();
        }

        function triggerGlobalRebalancing() {
            const event = {
                type: 'global_capacity_rebalancing',
                data: { from: 'Singapore', to: 'Mobile', mt: 1200 },
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            
            // Show alert banner
            showAlert('üåè Global rebalancing: 1,200 MT capacity shifted from Singapore to Mobile plant');
            
            // Update UI
            const singaporeInv = parseFloat(document.getElementById('singaporeInventory').textContent);
            document.getElementById('singaporeInventory').textContent = (singaporeInv - 1.2).toFixed(1) + 'K MT';
            
            const mobileInv = parseFloat(document.getElementById('mobileInventory').textContent);
            document.getElementById('mobileInventory').textContent = (mobileInv + 1.2).toFixed(1) + 'K MT';
            
            addTimelineEvent('üåè', 'Global SC', 'Capacity rebalanced: 1,200 MT from Singapore to Mobile');
            
            toggleDemoMenu();
        }

        function resetDemo() {
            const event = {
                type: 'reset',
                data: {},
                timestamp: new Date().toISOString(),
                source: 'coordination_hub'
            };
            broadcastEvent(event);
            // Hide shutdown impact on reset
            document.getElementById('shutdownImpact').style.display = 'none';
            location.reload();
        }

        function broadcastEvent(event) {
            localStorage.setItem('evonik_coordination_event', JSON.stringify(event));
            setTimeout(() => localStorage.removeItem('evonik_coordination_event'), 100);
        }

        function addTimelineEvent(icon, source, text) {
            const timeline = document.getElementById('timelineList');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const item = document.createElement('li');
            item.className = 'timeline-item';
            item.innerHTML = `
                <div class="timeline-time">${timeStr}</div>
                <div class="timeline-content">
                    <span class="timeline-icon">${icon}</span>
                    <strong>${source}:</strong> ${text}
                </div>
            `;
            
            timeline.insertBefore(item, timeline.firstChild);
            
            while (timeline.children.length > 5) {
                timeline.removeChild(timeline.lastChild);
            }
        }

        function addAlert(icon, title, detail) {
            const alertsList = document.getElementById('alertsList');
            const alertCount = document.getElementById('alertCount');
            
            const item = document.createElement('li');
            item.className = 'alert-item';
            item.innerHTML = `
                <span class="alert-icon">${icon}</span>
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <div class="alert-detail">${detail}</div>
                </div>
            `;
            
            alertsList.insertBefore(item, alertsList.firstChild);
            
            const currentCount = parseInt(alertCount.textContent);
            alertCount.textContent = (currentCount + 1) + ' Active';
        }

        function showAlert(message) {
            const banner = document.getElementById('alertsBanner');
            const alertMessage = document.getElementById('alertMessage');
            if (banner && alertMessage) {
                alertMessage.textContent = message;
                banner.classList.add('show');
                // No automatic timeout - user must close manually with X button
            }
        }

        function closeAlert() {
            const banner = document.getElementById('alertsBanner');
            if (banner) {
                banner.classList.remove('show');
            }
        }

        // User session handling
        function initializeUserSession() {
            const userSession = localStorage.getItem('evonik_user_session');
            if (!userSession) {
                // No session found, redirect to login
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const session = JSON.parse(userSession);
                
                // Check if user just logged in (redirect to role-specific dashboard)
                // Redirect if login was within last 5 seconds (fresh login) and not management
                const loginTime = new Date(session.loginTime);
                const now = new Date();
                const secondsSinceLogin = (now - loginTime) / 1000;
                const isFreshLogin = secondsSinceLogin < 5;
                
                // Redirect to role-specific primary dashboard (except management)
                if (isFreshLogin && session.role !== 'management') {
                    redirectToRoleDashboard(session.role);
                    return;
                }
                
                updateUserDisplay(session);
                applyRoleBasedAccess(session);
            } catch (error) {
                console.error('Invalid session data:', error);
                localStorage.removeItem('evonik_user_session');
                window.location.href = 'login.html';
            }
        }
        
        function redirectToRoleDashboard(role) {
            const roleDashboardMap = {
                'supply_chain': 'local-supply-chain-new.html',
                'plant_manager': 'production-new.html',
                'sales': 'sales-new.html',
                'operations': 'production-new.html',
                'management': 'index-new.html' // Management stays on coordination hub
            };
            
            const dashboard = roleDashboardMap[role];
            if (dashboard && dashboard !== 'index-new.html') {
                window.location.href = dashboard;
            }
        }
        
        function updateUserDisplay(session) {
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) {
                userDisplay.textContent = `${session.name} (${session.role.replace('_', ' ').toUpperCase()})`;
            }
        }
        
        function applyRoleBasedAccess(session) {
            const permissions = session.permissions;
            
            // Hide/show navigation items based on role
            const navItems = document.querySelectorAll('.stakeholder-btn');
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href) {
                    let dashboard = href.replace('-new.html', '').replace('.html', '');
                    
                    // Map specific dashboard names to permission names
                    const dashboardMapping = {
                        'global-supply-chain': 'global-sc',
                        'local-supply-chain': 'local-sc',
                        'optimizer': 'optimizer',
                        'sales': 'sales',
                        'production': 'production',
                        'index-new': 'hub'
                    };
                    
                    dashboard = dashboardMapping[dashboard] || dashboard;
                    
                    if (!permissions.dashboards.includes(dashboard)) {
                        item.style.display = 'none';
                    }
                }
            });
            
            // Apply role-specific styling or restrictions
            if (session.role === 'management') {
                document.body.classList.add('management-view');
            }
        }
        
        // Plant Operations Chart
        let plantOperationsChart = null;
        
        function initializePlantOperationsChart() {
            const ctx = document.getElementById('plantOperationsChart');
            if (!ctx) return;
            
            const me5Text = document.getElementById('me5Output').textContent;
            const me6Text = document.getElementById('me6Output').textContent;
            const me5Value = parseInt(me5Text.match(/\d+/)[0]);
            const me6Value = parseInt(me6Text.match(/\d+/)[0]);
            const totalValue = me5Value + me6Value;
            
            plantOperationsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ME5 Unit', 'ME6 Unit', 'Total Output'],
                    datasets: [{
                        label: 'Production (MT/day)',
                        data: [me5Value, me6Value, totalValue],
                        backgroundColor: [
                            'rgba(139, 46, 139, 0.7)',
                            'rgba(139, 46, 139, 0.7)',
                            'rgba(168, 85, 247, 0.8)'
                        ],
                        borderColor: [
                            'rgba(139, 46, 139, 1)',
                            'rgba(139, 46, 139, 1)',
                            'rgba(168, 85, 247, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 6
                    }, {
                        label: 'Target',
                        data: [620, 345, 965],
                        type: 'line',
                        borderColor: 'rgba(234, 88, 12, 0.8)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y + ' MT/day';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1200,
                            title: {
                                display: true,
                                text: 'Production Output (MT/day)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                stepSize: 200
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function updatePlantOperationsChart(me5Value, me6Value, totalValue) {
            if (plantOperationsChart) {
                plantOperationsChart.data.datasets[0].data = [me5Value, me6Value, totalValue];
                plantOperationsChart.update();
            }
        }
        
        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserSession();
            initializePlantOperationsChart();
            
            // Production Flow Map - Simplified focus on shipment flows
            // Wait a bit to ensure Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                return;
            }

            const mapEl = document.getElementById('plantWorldMap');
            if (!mapEl) {
                console.error('Map element #plantWorldMap not found');
                return;
            }

            // Ensure container has dimensions
            if (mapEl.offsetHeight === 0) {
                console.warn('Map container has no height, waiting...');
                setTimeout(() => {
                    // Retry initialization after a delay
                    initializeMap();
                }, 500);
                return;
            }

            // Initialize map function
            function initializeMap() {
                // Declare map variable
                let map;
                
                try {
                    // Create map instance
                    map = L.map('plantWorldMap', { 
                        zoomControl: true, 
                        worldCopyJump: true,
                        preferCanvas: true
                    }).setView([20, 0], 2);
                    
                    // Add tile layer
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 8,
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                    
                    // Force map to invalidate size after a short delay to ensure it renders
                    setTimeout(() => {
                        if (map) map.invalidateSize();
                    }, 100);
                    
                    // Plant locations
                    const plants = {
                        'Singapore': { 
                            name: 'Jurong Island (ME5/ME6)',
                            city: 'Singapore',
                            lat: 1.3009, 
                            lon: 103.7876
                        },
                        'Belgium': { 
                            name: 'Antwerp Plant',
                            city: 'Antwerp',
                            lat: 51.2600, 
                            lon: 4.4020
                        },
                        'United States': { 
                            name: 'Mobile Plant',
                            city: 'Mobile, Alabama',
                            lat: 30.6954, 
                            lon: -88.0399
                        }
                    };

                    // Regional destination points
                    const regions = {
                        'APAC': { lat: 20, lon: 110 },
                        'Europe': { lat: 50, lon: 10 },
                        'Americas': { lat: 30, lon: -90 }
                    };

                    // Shipment flows - showing real-time allocation
                    // Singapore serves multiple regions (to demonstrate coverage)
                    const shipmentFlows = [
                        // Singapore flows - covering multiple regions
                        { 
                            from: 'Singapore', 
                            to: 'APAC', 
                            volume: 'high', 
                            mt: 28950, 
                            color: '#8B2E8B',
                            status: 'in-transit' // in-transit, scheduled, delivered
                        },
                        { 
                            from: 'Singapore', 
                            to: 'Europe', 
                            volume: 'medium', 
                            mt: 4200, 
                            color: '#A855F7',
                            status: 'in-transit'
                        },
                        { 
                            from: 'Singapore', 
                            to: 'Americas', 
                            volume: 'low', 
                            mt: 1800, 
                            color: '#C084FC',
                            status: 'scheduled'
                        },
                        // Antwerp flows
                        { 
                            from: 'Belgium', 
                            to: 'Europe', 
                            volume: 'high', 
                            mt: 15600, 
                            color: '#8B2E8B',
                            status: 'in-transit'
                        },
                        // Mobile flows
                        { 
                            from: 'United States', 
                            to: 'Americas', 
                            volume: 'high', 
                            mt: 13500, 
                            color: '#8B2E8B',
                            status: 'in-transit'
                        }
                    ];

                    // Helper function to create animated curved flow line
                    function createFlowLine(from, to, volume, color, mt) {
                        const lat1 = from.lat, lon1 = from.lon;
                        const lat2 = to.lat, lon2 = to.lon;
                        
                        // Create curved path for visual appeal
                        const midLat = (lat1 + lat2) / 2;
                        const midLon = (lon1 + lon2) / 2;
                        const curve = 8; // curve intensity
                        
                        const controlLat = midLat + curve;
                        const controlLon = midLon;
                
                        const points = [];
                        for (let i = 0; i <= 50; i++) {
                            const t = i / 50;
                            const lat = (1-t)*(1-t)*lat1 + 2*(1-t)*t*controlLat + t*t*lat2;
                            const lon = (1-t)*(1-t)*lon1 + 2*(1-t)*t*controlLon + t*t*lon2;
                            points.push([lat, lon]);
                        }
                        
                        const lineWidth = volume === 'high' ? 6 : volume === 'medium' ? 4 : 2;
                        
                        const polyline = L.polyline(points, {
                            color: color,
                            weight: lineWidth,
                            opacity: 0.8,
                            dashArray: '15, 10',
                            className: `flow-line ${volume}-volume`
                        }).addTo(map);
                        
                        // Add volume label at midpoint
                        const midPoint = points[Math.floor(points.length / 2)];
                        L.marker(midPoint, {
                            icon: L.divIcon({
                                className: 'flow-label',
                                html: `<div class="flow-label-badge">${mt.toLocaleString()} MT</div>`,
                                iconSize: [null, null],
                                iconAnchor: [0, 0]
                            })
                        }).addTo(map);
                        
                        return polyline;
                    }

                    // Add plant markers
                    const plantMarkers = [];
                    Object.entries(plants).forEach(([country, plant]) => {
                        const marker = L.circleMarker([plant.lat, plant.lon], {
                            radius: 12,
                            color: '#FFFFFF',
                            weight: 3,
                            fillColor: '#8B2E8B',
                            fillOpacity: 0.95,
                            className: 'plant-marker'
                        }).addTo(map);
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                <strong>${plant.name}</strong><br/>
                                üìç ${plant.city}, ${country}
                            </div>
                        `);
                        
                        marker.bindTooltip(plant.name, { permanent: false, direction: 'top' });
                        plantMarkers.push(marker);
                    });

                    // Add shipment flow lines
                    shipmentFlows.forEach(flow => {
                        const plant = plants[flow.from];
                        const region = regions[flow.to];
                        
                        if (plant && region) {
                            createFlowLine(
                                { lat: plant.lat, lon: plant.lon },
                                { lat: region.lat, lon: region.lon },
                                flow.volume,
                                flow.color,
                                flow.mt
                            );
                        }
                    });

                    // Add region labels
                    Object.entries(regions).forEach(([regionName, coords]) => {
                        L.marker([coords.lat, coords.lon], {
                            icon: L.divIcon({
                                className: 'region-label',
                                html: `<div style="background: rgba(139, 46, 139, 0.9); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">${regionName}</div>`,
                                iconSize: [null, null],
                                iconAnchor: [0, 0]
                            })
                        }).addTo(map);
                    });

                    // Fit map to show all flows
                    if (map && plantMarkers.length > 0) {
                        const bounds = L.latLngBounds(plantMarkers.map(m => m.getLatLng()));
                        Object.values(regions).forEach(region => bounds.extend([region.lat, region.lon]));
                        map.fitBounds(bounds.pad(0.2));
                    }
                    
                } catch (error) {
                    console.error('Error initializing map:', error);
                    const mapEl = document.getElementById('plantWorldMap');
                    if (mapEl) {
                        mapEl.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">‚ö†Ô∏è Map initialization error. Please check console for details.</div>';
                    }
                }
            }
            
            // Call initialize map
            initializeMap();
        });

        // Listen for events from other pages
        window.addEventListener('storage', function(e) {
            if (e.key === 'evonik_coordination_event' && e.newValue) {
                const event = JSON.parse(e.newValue);
                console.log('Received coordination event:', event);
            }
        });
    </script>
</body>
</html>